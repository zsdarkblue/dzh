define("views/_base",["_base","observable","jquery","datetime","dialog","filter","select","splitter","grid","ztree"],function(t,e){return t.extend([e],function(t){$.extend(this,t),this.root.on("click","[data-bind$=Click]",this.handleEvent.bind(this)),this.root.on("change","[data-bind$=Change]",this.handleEvent.bind(this)),setTimeout(function(){"function"==typeof this.init&&this.init(t),this.emit("init")}.bind(this),0)},{handleEvent:function(t){var e=t.currentTarget.dataset.bind;e in this&&"function"==typeof this[e]&&this[e](t),this.emit(e.replace(/^on\w/,function(t){return t.slice(-1).toLowerCase()}),t.currentTarget.value||t.currentTarget.dataset)}})}),define("presenters/_base",["_base"],function(t){return t.extend(function(t){this.view=t})}),define("repositories/_base",["_base","socket"],function(t){return t.extend(function(){},{})}),define("repositories/notice",["./_base"],function(t){return new(t.extend({getParams:function(t){return $.extend(t,{so:"jso-ui-notice_new.jar",paraencode:"base64",request_timeout:15})},getTreeNodesByType:function(t){return $.getJSON("resources/tree_"+t+".json")},getNotice:function(t){var e={};for(pName in t)e[pName]=t[pName];(t.objCode||t.cvlist||t.subId)&&e.type&&delete e.type;var i=function(){return"cvlist"in t?"gw.sh.func.NoticeFavoritesRequest":"gw.sh.func.NoticeSearchRequest"};return $.send("/rpc",this.getParams({"function":i(),parameter:(external.base64encode||btoa)(JSON.stringify(e))}))},getNoticeCount:function(t){return"cvlist"in t?$.Deferred():this.getNotice($.extend({count:1},t))},getNoticeContent:function(t,e){return $.send("/rpc",this.getParams({"function":"gw.sh.func.NoticeGetDetailRequest",parameter:(external.base64encode||btoa)(JSON.stringify({type:e,noticeid:t}))}))},deleteOldLocalStorage:function(){function t(t,i){if(t in localStorage){var n=JSON.parse(localStorage.getItem(t));n.forEach(function(t){for(var n=0,a=e.length;a>n;n++)t.name==e[n].name&&(t.name=t.name+"_"+i)}),e=e.concat(n),localStorage.removeItem(t)}}var e=[];t("$bulletin.stock.favorites","股票"),t("$bulletin.bond.favorites","债券"),t("$bulletin.fund.favorites","基金"),t("$bulletin.financial.favorites","理财"),t("$bulletin.stock_hk.favorites","港股"),e.length>0&&this.setFavorites("",e)},getFavorites:function(t){{var e=$.Deferred();["$bulletin",t,"favorites"].join(".")}return this.deleteOldLocalStorage(),e.resolve("$bulletin.all.favorites"in localStorage?JSON.parse(localStorage.getItem("$bulletin.all.favorites")):[]),e},setFavorites:function(t,e){return e.forEach(function(t){var e=[],i=t.keys?t.keys.split(","):[],n=i.length>300?i.length-300:0;for(l=i.length;l>n;n++)i[n]in e||(e[i[n]]=!0,e.push(i[n]));t.keys=e.join(","),e.length=0,e=void 0}),localStorage.setItem("$bulletin.all.favorites",JSON.stringify(e)),this.getFavorites(t)},getNoticeTypeTree:function(){return $.getJSON("resources/noticeTypeTree.json")},getSubAppdicId:function(){return $.send("/rpc",{so:"jso-common-userprefer.jar","function":"gw.sh.func.UserPreferEntryRequest",paraencode:"base64",parameter:(external.base64encode||btoa)('{action:"select",type:"appdic",name:"bulletin"}')})},getSubUserdata:function(t,e){return $.send("/rpc",{so:"jso-common-userprefer.jar","function":"gw.sh.func.UserPreferEntryRequest",paraencode:"base64",parameter:(external.base64encode||btoa)('{action:"query",type:"userdata",user:"'+t+'",appid:"'+e.id+'",categoryid:0}')})},insertSubUserdata:function(t,e,i){return i.value=i.value.replace(/\"null\"/g,'""'),$.send("/rpc",{so:"jso-common-userprefer.jar","function":"gw.sh.func.UserPreferEntryRequest",paraencode:"base64",parameter:(external.base64encode||btoa)('{action:"insert",type:"userdata",user:"'+t+'",appid:"'+e[0].id+'",categoryid:0,title:"noticesubscription",data:'+JSON.stringify(i)+"}")})},updateSubUserData:function(t,e){return e.value=e.value.replace(/\"null\"/g,'""'),$.send("/rpc",{so:"jso-common-userprefer.jar","function":"gw.sh.func.UserPreferEntryRequest",paraencode:"base64",parameter:(external.base64encode||btoa)('{action:"update",type:"userdata",udid:"'+t+'",data:'+JSON.stringify(e)+"}")})},getStocksName:function(t){return $.send("/objinfo/getinfo",{field:"obj,name",where:"obj="+t,response_times:1,response_mode:0})},getOjbectName:function(t){return $.send("/rpc",{so:"jso-ui-commoncode.jar","function":"gw.sh.func.ChineseNameByCodeRequest",paraencode:"base64",parameter:(external.base64encode||btoa)('{"co":"'+t+'"}')})}}))}),define("repositories/securities",["./_base"],function(t){return new(t.extend({filterReg:{bond:new RegExp("\\.bond$"),financial:new RegExp("^(?:SH|SZ|OF)\\d+\\.fnd$"),fund:new RegExp("^(?:SH|SZ|OF)\\d+\\.fnd$"),stock:new RegExp("^(?:SH|SZ)\\d{6}\\.stk$"),stock_hk:new RegExp("^HK\\d{5}\\.stk$")},getSecurities:function(t,e){return $.send("/keyspirit/search",{key:encodeURI(t),f:0,e:{bond:"N3",financial:"A1",fund:"N2",stock:"N1",stock_hk:"N4"}[e],__encoding:"gbk",l:10})},getTreeNodes:function(t,e,i){return $.send("/rpc",{so:"jso-all-treequery.jar","function":"gw.sh.func.QueryChildTreeRequest",paraencode:"base64",parameter:btoa(JSON.stringify({did:t,node:e,returntype:0,querydepth:i?-1:1,nodetype:0,result:i?1:0})),request_timeout:20})},getBlockInfo:function(t){return $.send({service:"blockinfo",type:t?"leaf":"sub",source:"local",block:t||"自选股",depth:1})},getOptionalSecurities:function(t){var e=$.Deferred();return this.getBlockInfo().then(function(i){var n=i.map(function(t){return t.blockname},this),a=n.map(function(t){return this.getBlockInfo(t)},this);$.when.apply($,a).then(function(){for(var i={},a=[],s=(this.filterReg[t],0),r=arguments.length;r>s;s++)for(var o=n[s],d=arguments[s],c=0,h=d.length;h>c;c++){var l=d[c];o in i?!(l.stockid in i[o])&&i[o].push(l.stockid):i[o]=[l.stockid],i[o][l.stockid]=!0}for(var u in i)a.push({name:u,objCode:i[u].join(",")});e.resolve(a)}.bind(this))}.bind(this)),e},getRanges:function(t){switch(t){case"financial":return[["","全部"],["0100000","银行理财产品公告"],["0200000","信托产品公告"],["0300000","保险产品公告"],["0400000","集合理财公告"]];case"fund":return[["","全部"],["105228","股票型基金"],["105233","混合型基金"],["105239","债券型基金"],["105245","货币式基金"],["105246","QDII基金"],["111594","商品基金"],["105200","ETF基金"],["105201","LOF基金"],["105203","指数型基金"],["105210","分级基金"]];case"stock":return[["","全部"],["100088","沪市主板公告"],["100090","深市主板公告"],["100097","中小板公告"],["102689","创业板公告"]];case"stock_hk":return[["100618","全部"],["100620","港股主板"],["100622","港股创业板"],["100619","H股"],["109926","含A股的H股"],["100621","红筹股"],["109927","蓝筹股"],["109928","含认购证的港股"],["100065","待上市港股"]];default:return[["","全部"]]}},getSecuritiesTreeStore:function(){return{query:function(t){var e=$.Deferred();return t?t.did?(e.did=t.did,this.getTreeNodes(t.did,t.code).then(function(t){var e=[];t.forEach(function(t){e.push({did:this.did,code:t.C3,name:t.C8,isParent:t.C7>0})},this),this.resolve(e)}.bind(e))):this.getBlockInfo().then(function(t){var e=[];t.forEach(function(t,i){i&&e.push({name:t.blockname})}),this.resolve(e)}.bind(e)):e.resolve([{did:41522,code:112310,name:"股票",isParent:1},{did:41514,code:100007,name:"港股",isParent:1},{did:41505,code:100003,name:"债券",isParent:1},{did:41504,code:105190,name:"基金",isParent:1},{name:"自选股",isParent:1}]),e}.bind(this)}}}))}),define("presenters/index",["./_base","../repositories/notice","../repositories/securities"],function(base,noticeRepository,securitiesRepository){return base.extend(function(){this.view.on("init",this.onInit.bind(this)),this.view.on("treeNodesClick",this.onTreeNodesClick.bind(this)),this.view.on("pagerChange",this.onPagerChange.bind(this)),this.view.on("articleLinkClick",this.onArticleLinkClick.bind(this)),this.view.on("prevArticleLinkClick",this.onPrevArticleLinkClick.bind(this)),this.view.on("nextArticleLinkClick",this.onNextArticleLinkClick.bind(this)),this.view.on("attachmentLinkClick",this.onAttachmentLinkClick.bind(this)),this.view.on("filterInput",this.onFilterInput.bind(this)),this.view.on("searchBtnClick",this.onSearchBtnClick.bind(this)),this.view.on("advSearchBtnClick",this.onAdvSearchBtnClick.bind(this)),this.view.on("favoritesBtnClick",this.onFavoritesBtnClick.bind(this)),this.view.on("favoritesChange",this.onFavoritesChange.bind(this)),this.view.on("removeFavoritesBtnClick",this.onRemoveFavoritesBtnClick.bind(this)),this.view.on("exportBtnClick",this.onExportBtnClick.bind(this)),this.view.on("subscriptionBtnClick",this.onSubscriptionBtnClick.bind(this)),this.view.on("insetSubDataClick",this.onInsetSubDataClick.bind(this)),this.view.on("updateSubDataClick",this.onUpdateSubDataClick.bind(this))},{onInit:function(){this.obj=decodeURI((location.search.match(/\bobj=([^&]*)/)||[,""])[1]),this.type=decodeURI((location.search.match(/\btype=([^&]*)/)||[,"stock"])[1]),this.node=decodeURI((location.search.match(/\bnode=([^&]*)/)||[,"最新公告"])[1]),this.pageCount=1;var t={stock:0,bond:2,fund:3,financial:4,stock_hk:1};$(".notice-sort>a:eq("+t[this.type]+")").css("background-image","-webkit-linear-gradient(top, #fcdd85, #f6ab34)"),this.args={type:{stock:3,bond:10,fund:7,financial:"14,15,16,17",stock_hk:6}[this.type]||3,pageNum:1,pageSize:50,bdate:"",edate:"",count:1},this.obj&&(this.args.objCode=this.obj,this.args.bdate="",this.args.edate="",this.view.renderSearchCode(this.obj)),this.view.renderGrid([]),noticeRepository.getTreeNodesByType(this.type).then(function(t){this.view.renderTree(t),$.when(this.updateFavorites(),this.updateSecurities(),this.updateSubscription()).then(function(){this.view.renderNode(this.node)}.bind(this))}.bind(this))},onTreeNodesClick:function(t){if(arguments.length){if(this.lock=!1,this.fixArgs({}),t.keys&&t.keys.indexOf("#")>-1)this.args.cvlist=t.keys,this.args.index=t.index;else if(t.subId){if(this.args.subId=t.subId,t.itemId&&(this.args.itemId=t.itemId),t.titleKey&&"undefined"!=t.titleKey&&(this.args.titleKey=t.titleKey),t.objCode&&(this.args.objCode=t.objCode),"4"==t.dateId)this.args.bdate=t.bdate.replace(/-/g,"")+"000000",this.args.edate=t.edate.replace(/-/g,"")+"235959";else if(t.dateId&&"0"!=t.dateId){var e=new Date,i=e.getFullYear(),n=e.getMonth()>8?e.getMonth()+1:"0"+(e.getMonth()+1),a=e.getDate()>9?e.getDate():"0"+e.getDate();this.args.edate=""+i+n+a+"235959";var s=new Date;"1"==t.dateId?s.setMonth(s.getMonth()-1):"2"==t.dateId?s.setMonth(s.getMonth()-3):"3"==t.dateId&&s.setMonth(s.getMonth()-6);var r=s.getFullYear(),o=s.getMonth()>8?s.getMonth()+1:"0"+(s.getMonth()+1),d=s.getDate()>9?s.getDate():"0"+s.getDate();this.args.bdate=""+r+o+d+"000000"}}else t.keys?(t.keys.indexOf(".")>-1?this.args.objCode=t.keys:this.args.itemId=t.keys,this.args.bdate="",this.args.edate=""):t.objCode?(this.args.objCode=t.objCode,this.args.bdate="",this.args.edate=""):this.obj?(this.args.objCode=this.obj,this.args.bdate="",this.args.edate="",this.view.renderSearchCode(this.obj)):(delete this.args.itemId,this.args.bdate="",this.args.edate="");this.updateNoticePageCount(),this.updateNoticeList()}else this.lock=!0,this.view.renderPager(1,1),this.view.grid.empty()},onPagerChange:function(t){this.lock||"pending"===this.listPromise.state()||(t=isNaN(Number(t))?1:Math.ceil(Number(t)),1>t&&(t=1),t>this.pageCount&&(t=this.pageCount),this.args.pageNum=Number(t),this.updateNoticeList()),this.view.renderPager(this.args.pageNum,this.pageCount)},onArticleLinkClick:function(t){this.updateNoticeContent(t.key,function(){this.view.renderArticle(this.article)}.bind(this))},onPrevArticleLinkClick:function(){this.article&&this.onArticleLinkClick({key:this.getNotice(this.article.CV).prev.CV})},onNextArticleLinkClick:function(){this.article&&this.onArticleLinkClick({key:this.getNotice(this.article.CV).next.CV})},onAttachmentLinkClick:function(t){this.updateNoticeContent(t.key,function(){this.view.renderAttachment(this.article,Number(t.index))}.bind(this))},onFilterInput:function(t){securitiesRepository.getSecurities(t,this.type).then(function(t){for(var e=[],i=0,n=t.length;n>i;i++)e.push({id:t[i]["bond"===this.type?"trcode":"obj"],name:t[i].obj.replace(/\..+$/,"　")+t[i].disp});this.view.renderFilterResults(e)}.bind(this))},onSearchBtnClick:function(t){this.fixArgs(t),this.args.bdate=t.bdate?t.bdate.replace(/-/g,"")+"000000":"",this.args.edate=t.edate?t.edate.replace(/-/g,"")+"235959":"",this.updateNoticePageCount(),this.updateNoticeList()},onAdvSearchBtnClick:function(){this.view.renderSearchDialog(securitiesRepository.getRanges(this.type))},onFavoritesBtnClick:function(){noticeRepository.getFavorites(this.type).then(function(t){this.view.renderFavoritesDialog(t.length?t:[{name:"收藏1"}])}.bind(this))},onFavoritesChange:function(t){noticeRepository.setFavorites(this.type,t).then(function(t){this.view.renderFavoritesNode(t)}.bind(this))},onRemoveFavoritesBtnClick:function(t){if(t.keys){var e=t.keys.split(",");noticeRepository.getFavorites(this.type).then(function(t){var i=t[this.args.index];if(i){for(var n=i.keys.split(","),a=n.length;a--;)for(var s=0,r=e.length;r>s;s++)-1!=e[s].indexOf(n[a])&&n.splice(a,1);i.keys=n.join(","),noticeRepository.setFavorites(this.type,t),this.view.changeFavoritesNode(this.args.index,i.keys)}}.bind(this))}},updateNoticeList:function(){this.listPromise&&this.listPromise.cancel(),this.tips=setTimeout(function(){this.view.grid.loading(),this.view.renderPager(this.args.pageNum,this.pageCount)}.bind(this),100);try{this.listPromise=noticeRepository.getNotice(this.args).then(function(t){clearTimeout(this.tips),t[1]&&(this.pageCount=Math.ceil(parseInt(t[1][0].COUNT)/50),this.view.renderPager(this.args.pageNum,this.pageCount)),this.noticeList=t[0],this.view.renderGrid(t[0]),0===t[0].length?this.view.grid.empty():this.onArticleLinkClick({key:this.getNotice().CV})}.bind(this),function(t){clearTimeout(this.tips),"cancel"!==t&&this.view.grid.error()}.bind(this))}catch(t){throw this.view.grid.error(),t}},updateNoticePageCount:function(){this.pageCount=1,this.args.pageNum=1,this.view.renderPager(this.args.pageNum,this.pageCount)},updateFavorites:function(){return noticeRepository.getFavorites(this.type).then(function(t){this.view.renderFavoritesNode(t)}.bind(this))},updateSecurities:function(){return securitiesRepository.getOptionalSecurities(this.type).then(function(t){!t.length&&t.push({name:"自选股",objCode:""}),this.view.renderSecuritiesNode(t)}.bind(this))},updateSubscription:function(){this.userid=window.external.getDZHProperty?window.external.getDZHProperty("userid"):"dzh127_003";window.external.getDZHProperty?window.external.getDZHProperty("userid"):"dzh127_003";return noticeRepository.getSubAppdicId().then(function(t){this.appidData=t,noticeRepository.getSubUserdata(this.userid,t[0]).then(function(t){0==t.length||"-301"==t[0].resultcode?(console.log("没有订阅数据"),this.subUserData=[]):(this.subUserData=t,this.changeSubTreeNode())}.bind(this))}.bind(this))},changeSubTreeNode:function(){for(var userDataArray=eval(JSON.parse(this.subUserData[0].data).value),i=0,l=userDataArray.length;l>i;i++)userDataArray[i].subId="1";this.view.renderSubscriptionNode(userDataArray)},updateNoticeContent:function(t,e){this.article=this.getNotice(t).item,"detail"in this.article?e():noticeRepository.getNoticeContent(this.article.C1,this.article.TYPE).then(function(t){t[0].C3=t[0].C3.replace(/\\/g,"/"),this.article.detail=t[0],e()}.bind(this))},getNotice:function(t){return!t||t+"\f"in this.noticeList||this.noticeList.forEach(function(t,e){this.noticeList[t.CV+"\f"]={item:t,prev:this.noticeList[e-1]||this.noticeList[this.noticeList.length-1],next:this.noticeList[e+1]||this.noticeList[0]}},this),t?this.noticeList[t+"\f"]:this.noticeList[0]},fixArgs:function(t){["cvlist","index","itemId","objCode","range","titleKey","bdate","edate","subId"].forEach(function(e){t[e]?this.args[e]=t[e]:delete this.args[e]},this),t=void 0},getDate:function(t){var e=new Date,i=parseInt(t);if(!isNaN(i))switch(t.slice(-1)){case"d":e.setDate(e.getDate()+i);break;case"m":e.setMonth(e.getMonth()+i);break;case"y":e.setFullYear(e.getFullYear()+i)}return new Date(e-6e4*e.getTimezoneOffset()).toJSON().replace(/\D/g,"").slice(0,8)+"000000"},onSubscriptionBtnClick:function(){window.external.getDZHProperty?window.external.getDZHProperty("userid"):"dzh127_003";noticeRepository.getNoticeTypeTree().then(function(t){this.view.onSubscriptionBtnClickAfter(t,this.userid,this.subUserData)}.bind(this))},onInsetSubDataClick:function(t){noticeRepository.insertSubUserdata(this.userid,this.appidData,t).then(function(t){t[0].id?(console.log("订阅成功"),this.subUserData=t,this.changeSubTreeNode()):console.log("订阅失败",t)}.bind(this))},onUpdateSubDataClick:function(t){noticeRepository.updateSubUserData(t.dataId,t.value).then(function(t){t[0].id?(console.log("订阅数据更新成功"),this.subUserData=t,this.changeSubTreeNode()):console.log("订阅数据更新失败",t)}.bind(this))},onExportBtnClick:function(){if(this.noticeList.length){var t="大智慧数据导出",e='<html xmlns:x="urn:schemas-microsoft-com:office:excel"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>'+t+'</x:Name><x:WorksheetOptions><x:Panes></x:Panes></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><meta http-equiv="content-type"content="text/html; charset=gbk"><style>.text{font-family:Arial;font-size:10pt;mso-number-format:"@"}</style></head><body>',i="</body></html>";if(window.external.saveas){var n=[],a="公告导出"+(new Date).getTime()+parseInt(1e5*Math.random());n.push(e),n.push("<table>"),n.push("<tbody>");for(var s=0;s<this.noticeList.length;s++)n.push("<tr>"),n.push("<td>"+this.noticeList[s].C2.replace(/^(\d{4})(\d{2})(\d{2})(\d{6})/,"$1-$2-$3")+"</td>"),n.push("<td> "+this.noticeList[s].C5+"&nbsp; </td>"),n.push("<td>"+this.noticeList[s].C6+"</td>"),n.push("<td>"+this.noticeList[s].C3+"</td>"),n.push("<td>"+this.noticeList[s].C4+"</td>"),n.push("</tr>");n.push("</tbody>"),n.push("</table>"),n.push(i),window.external.saveas(n.join(""),a,"xls"),n=[]}}}})}),define("views/widgets/grid",["grid"],function(t){return t.extend(function(){this.changeHandle()},{options:{forceFitColumns:!1,resizable:!1,resize:!0},formatter:{serial:function(t){return t+1},date:function(t,e,i){return i.substr(0,8).replace(/^(\d{4})(\d\d)(\d\d)/,"$1-$2-$3")},title:function(t,e,i,n,a){var s=a.C7.match(/[^,]+/g)||[""];if(s[0]=s[0].toLowerCase(),s.length>1)switch(s[0]){case"doc":case"docx":case"pdf":case"rar":case"txt":case"xls":case"xlsx":s[0]=s[0]+"-m";break;default:s[0]="multiple"}return['<a data-bind="onAttachmentLinkClick" data-key="',a.CV,'"><i class="icon-',s[0],'"></i></a> ','<a data-bind="onArticleLinkClick" data-key="',a.CV,'" title="',i,'">',i,"</a>"].join("")},favorites:function(t,e,i,n,a){return'<input type="checkbox" data-c1="'+a.C1+"#"+a.TYPE+'#" value="'+a.CV+"#"+a.TYPE+'">'}},getColumns:function(){var t=[{pwidth:"4%",name:"序号",cssClass:"center",formatter:this.formatter.serial},{pwidth:"10%",field:"C2",name:"公告日期",cssClass:"center",sortable:!0,formatter:this.formatter.date},{pwidth:"10%",field:"C5",name:"证券代码",cssClass:"center",sortable:!0},{pwidth:"14%",field:"C6",name:"证券简称",sortable:!0},{pwidth:"42%",field:"C3",name:"公告标题",sortable:!0,formatter:this.formatter.title},{pwidth:"12%",field:"C4",name:"公告类型",sortable:!0},{pwidth:"8%",name:'<button data-bind="'+this.btnHandle+'" class="btn-radius">'+this.btnContent+"</button>",cssClass:"center",formatter:this.formatter.favorites}];switch((location.search.match(/\btype=([^&]*)/)||[,"stock"])[1]){case"financial":t[3].pwidth=parseInt(t[3].pwidth)+parseInt(t[2].pwidth)+"%",t.splice(2,1);break;case"bond":case"fund":this.node.name in{"折算比例":1,"估值说明":1,"基金公司动态":1}&&(t[4].pwidth=parseInt(t[4].pwidth)+parseInt(t[3].pwidth)+parseInt(t[2].pwidth)+"%",t.splice(2,2))}return t.forEach(function(t,e){t.id=e}),t},render:function(t,e){return t.forEach(function(t,i){t.id=i,t.tPId=e}),this.base(t,this.getColumns()),this.instance.getData().setSerialField(1),this},loading:function(){this.render([]).target.find(">.slick-viewport").addClass("icon-loading")},tips:function(t){this.render([]).target.find(".grid-canvas").html('<div style="margin: 5px;">'+t+"</div>")},empty:function(){this.tips(this.emptyContent)},error:function(){this.tips("提示：服务器忙请求超时，请稍候重试")},getCheckedItems:function(){return this.target.find("input[type=checkbox]:checked").map(function(){return this.value}).toArray()},getCheckedDelteItems:function(){return this.target.find("input[type=checkbox]:checked").map(function(){return this.value+this.getAttribute("data-c1")}).toArray()},changeHandle:function(t){if(t){if("公告收藏"===(t.getParentNode()||{}).name)return this.emptyContent="提示：无收藏记录",this.btnContent='<i class="fa fa-trash-o"></i> 删除',void(this.btnHandle="onRemoveFavoritesBtnClick");this.node=t}else this.node={};this.emptyContent="提示：该品种无此项记录，或在当前筛选条件下无数据",this.btnContent='<i class="fa fa-star"></i> 收藏',this.btnHandle="onFavoritesBtnClick"}})}),define("views/widgets/confirm_dialog",["dialog"],function(t){return t.extend(function(){this.target.on("click","[data-bind$=Click]",this.handleEvent.bind(this)),this.target.on("change","[data-bind$=Change]",this.handleEvent.bind(this))},{onConfirmBtnClick:function(){this.emit("confirm"),this.hide()},onCancelBtnClick:function(){this.emit("cancel"),this.hide()},handleEvent:function(t){var e=t.currentTarget.dataset.bind;this.emit(e.replace(/^on\w/,function(t){return t.slice(-1).toLowerCase()}),t.currentTarget.value||t.currentTarget.dataset)}})}),define("views/widgets/search_dialog",["./confirm_dialog"],function(t){return t.extend(function(){var t=this.target.find("select");this.filter=this.target.find("input[type=search]"),this.ranges=this.target.find("input[type=datetime]"),this.dateSelect=t.eq(0),this.rangeSelect=t.eq(1).on("init",function(){this.rangeSelect.widget().menu.on("change","input",this.onRangeSelectChange.bind(this))}.bind(this)),this.onDateSelectChange(),/type=financial/.test(location.search)&&(this.filter.parent().hide(),this.rangeSelect.parent().hide())},{onDateSelectChange:function(){var t=Number(this.dateSelect.val()),e=new Date,i=new Date,n=function(t){return new Date(t-6e4*t.getTimezoneOffset()).toJSON().slice(0,10)};t&&(e.setMonth(i.getMonth()-t),this.ranges.prop("disabled",!1),this.ranges.eq(0).val(n(e)),this.ranges.eq(1).val(n(i))),12==t&&(this.ranges.eq(0).val(""),this.ranges.eq(1).val("")),this.ranges.prop("disabled",!!t)},onRangeSelectChange:function(t){if(t.target.checked){var e=$(t.target.parentNode.parentNode.parentNode).find("input");e.filter(":"+("全部"===t.target.parentNode.children[1].innerText?"gt":"eq")+"(0)").not(t.target).prop("checked",!1),e.toArray().forEach(function(t,e){this.rangeSelect[0].options[e].selected=t.checked}.bind(this))}},onConfirmBtnClick:function(t){var e=this.filter.val(),i=this.ranges.prop("disabled");this.filter.val(this.filter.attr("data-id")||""),this.ranges.prop("disabled",!1),this.params={},this.target.find("form").serializeArray().forEach(function(t){t.value&&(this.params[t.name]=t.name in this.params?this.params[t.name]+","+t.value:t.value)},this),this.filter.val(e),this.ranges.prop("disabled",i),this.emit("change",this.params),this.base(t)},renderRangeSelect:function(t){if(!this.rangeSelect.widget()){var e=[];t.forEach(function(t){this.push('<option value="',t[0],'">',t[1],"</option>")},e),this.rangeSelect.html(e.join(""))}}})}),define("views/widgets/tree_dialog",["./confirm_dialog"],function(t){return t.extend(function(){this.renderTree(this.cloneNodes())},{onConfirmBtnClick:function(t){var e=[];this.items={},this.value=[],this.tree.getNodesByFilter(function(t){return t.checked&&1!==t.check_Child_State}).forEach(function(t){this.value.push(t.name),t.keys&&t.keys.split(",").forEach(function(t){this[t]=!0},this.items)}.bind(this));for(var i in this.items)e.push(i);this.emit("change",this.value.join(","),e.join(",")),this.base(t)},cloneNodes:function(t,e){return t=t||this.nodes,e=e||[],t.forEach(function(t){var e={name:t.name,keys:t.keys,open:t.open};this[1].push(e),t.children&&(e.children=[],this[0](t.children,e.children))},[arguments.callee,e]),e},renderTree:function(t){this.tree=$.fn.zTree.init(this.target.find(".ztree"),{check:{enable:!0},view:{dblClickExpand:!1,expandSpeed:"",nameIsHTML:!0,selectedMulti:!1,showIcon:!1,showTitle:!1}},t)}})}),define("views/widgets/favorites_dialog",["./confirm_dialog"],function(t){return t.extend(function(){this.list=this.target.find("ul").on("click","li",this.onItemClick.bind(this)).on("blur","input",this.onItemBlur.bind(this)),this.setActiveItem()},{onItemClick:function(t){this.setActiveItem($(t.currentTarget))},onItemBlur:function(){var t=this.activeItem.find("input").remove().val().trim()||this.activeItem.attr("data-name");t?this.activeItem.removeClass("edit").text(t).attr("data-name",this.activeItem.text()):(this.activeItem.remove(),this.setActiveItem())},onAddBtnClick:function(){var t=$("<li></li>");this.list.append(t),this.setActiveItem(t),this.setEditItem()},onEditBtnClick:function(){this.setEditItem()},onRemoveBtnClick:function(){this.activeItem.remove(),this.setActiveItem()},onMoveUpBtnClick:function(){this.activeItem.prev().before(this.activeItem)},onMoveDownBtnClick:function(){this.activeItem.next().after(this.activeItem)},onConfirmBtnClick:function(t){var e=[],i=this.activeItem.attr("data-keys");i=(i?i.split(","):[]).concat(this.keys),this.activeItem.attr("data-keys",i),this.list.children().each(function(){e.push({name:this.dataset.name,keys:this.dataset.keys||""})}),this.emit("change",e),e=void 0,this.base(t)},setActiveItem:function(t){this.activeItem=(t||this.list.children().first()).siblings().removeClass("active").end().addClass("active")},setEditItem:function(t){this.editItem=(t||this.activeItem).addClass("edit"),this.editItem.html('<input type="text">').find("input").val(this.editItem.attr("data-name")||"").focus()},render:function(t){var e=[];return t.forEach(function(t,i){e.push("<li",i?"":' class="active"',' data-name="',t.name,'" data-keys="',t.keys,'">',t.name,"</li>")},e),this.list.html(e.join("")),this.setActiveItem(),this}})}),define("views/widgets/subscription_dialog",["./confirm_dialog","../../repositories/notice"],function(dialog,noticeRepository){return dialog.extend(function(target,options){function zTreeOnCheck(){for(var t=$.fn.zTree.getZTreeObj("noticeTypeTree"),e=t.getCheckedNodes(),i=[],n=[],a=0,s=e.length;s>a;a++)e[a].keys&&(i.push(e[a].name),n.push(e[a].keys));$("#userSubUL >li.active").attr("data-typeKeys",n.join()),$("#subTypeSpan").html(i.join())}var typeTreeSetting={treeId:"subTypeTree",check:{chkboxType:{Y:"ps",N:"ps"},chkStyle:"checkbox",enable:!0},view:{dblClickExpand:!1,expandSpeed:"",nameIsHTML:!0,selectedMulti:!1,showIcon:!1,showTitle:!1},callback:{onCheck:zTreeOnCheck}};if(this.typeTree=$.fn.zTree.init($("#noticeTypeTree"),typeTreeSetting,options.typeTreeNodes),$("#subTypeSpan").click(function(){$("#noticeTypeContent").css("display","block"),event.stopPropagation()}),$("#search_select").click(function(){$("#noticeTypeContent").css("display","block"),event.stopPropagation()}),$("#noticeTypeContent").click(function(){event.stopPropagation()}),$("body").click(function(){$("#noticeTypeContent").css("display","none")}),0==options.subUserData.length)$("#userSubUL").attr("data-id","0"),$("#userSubUL").append("<li>公告订阅1</li>");else{var subUserData=options.subUserData[0];$("#userSubUL").attr("data-id",subUserData.id);var userDataArray=eval(JSON.parse(subUserData.data).value),liHtmlStr="";if(0==userDataArray.length)liHtmlStr="<li>公告订阅1</li>";else for(var liHtmlStr="",i=0,l=userDataArray.length;l>i;i++)liHtmlStr+='<li data-title="'+userDataArray[i].titleKey+'"',userDataArray[i].itemId&&(liHtmlStr+=' data-typeKeys="'+userDataArray[i].itemId+'"'),userDataArray[i].dateId&&(liHtmlStr+=' data-dateId="'+userDataArray[i].dateId+'"',4==parseInt(userDataArray[i].dateId)&&(liHtmlStr+=' data-bdate="'+userDataArray[i].bdate+'"',liHtmlStr+=' data-edate="'+userDataArray[i].edate+'"')),userDataArray[i].objCode&&(liHtmlStr+=' data-code="'+userDataArray[i].objCode+'"'),liHtmlStr+=">"+userDataArray[i].name+"</li>";$("#userSubUL").append(liHtmlStr)}this.subListUl=this.target.find("ul.subscriptionName").on("click","li",this.onItemClick.bind(this)).on("blur","input",this.onItemBlur.bind(this)).on("dblclick","li",this.onEditBtnClick.bind(this)),this.setActiveItem(),this.subListUl[0].childNodes[0].click(),this.form=this.target.find("form").on("change","#EditorSubName",this.changeEditorSubName.bind(this)).on("change","#editorTitle",this.changeEditorTitle.bind(this)).on("change","#subDateSelect",this.changeDateSelect.bind(this)).on("change","#bdateInput",this.changeBdateInput.bind(this)).on("change","#edateInput",this.changeEdateInput.bind(this)).on("init","#objCodeInput",this.onFilterInit.bind(this)).on("filterChange","#objCodeInput",this.onFilterChange.bind(this)),$("#selectedStocksConfirmBtn").bind("click",this.onSelectedStocksConfirmClick.bind(this)),$("#selectedStocksCancelBtn").bind("click",function(){$("#objectDialog").hide()}),$("#pointConfirmBtn").bind("click",this.onPointConfirmClick.bind(this))},{onItemClick:function(t){this.setActiveItem($(t.currentTarget)),this.setEditorForm()},onItemBlur:function(){var t=this.activeItem.find("input").remove().val().trim()||this.activeItem.attr("data-name");t?(this.activeItem.removeClass("edit").text(t).attr("data-name",this.activeItem.text()),this.setEditorForm()):(this.activeItem.remove(),this.setActiveItem())},onAddBtnClick:function(){if(this.subListUl.children().length<13){var t=$("<li></li>");this.subListUl.append(t),this.setActiveItem(t),this.setEditItem()}},onEditBtnClick:function(){this.setEditItem()},onSubRemoveBtnClick:function(){this.activeItem.remove(),this.setActiveItem();var t=this;setTimeout(function(){t.setEditorForm()},100)},onMoveUpBtnClick:function(){this.activeItem.prev().before(this.activeItem)},onMoveDownBtnClick:function(){this.activeItem.next().after(this.activeItem)},setActiveItem:function(t){this.activeItem=(t||this.subListUl.children().first()).siblings().removeClass("active").end().addClass("active")},setEditItem:function(t){this.editItem=(t||this.activeItem).addClass("edit");var e=this.editItem[0].innerHTML;this.editItem.html('<input type="text">').find("input").val(this.editItem.attr("data-name")||e||"").focus()},checkTypeTreeNode:function(t){var t="";$("ul.subscriptionName > li.active").attr("data-typekeys")&&(t=$("ul.subscriptionName > li.active").attr("data-typekeys"));for(var e=this.typeTree.getNodes(),i=[],n=0,a=e.length;a>n;n++)for(var s=0;s<e[n].children.length;s++)if(e[n].children[s].children)for(var r=0;r<e[n].children[s].children.length;r++)e[n].children[s].children[r].keys&&-1!=t.indexOf(e[n].children[s].children[r].keys)?(this.typeTree.checkNode(e[n].children[s].children[r],!0,!0),i.push(e[n].children[s].children[r].name)):e[n].children[s].children[r].keys&&-1==t.indexOf(e[n].children[s].children[r].keys)&&this.typeTree.checkNode(e[n].children[s].children[r],!1,!0);else e[n].children[s].keys&&-1!=t.indexOf(e[n].children[s].keys)?(this.typeTree.checkNode(e[n].children[s],!0,!0),i.push(e[n].children[s].name)):e[n].children[s].keys&&-1==t.indexOf(e[n].children[s].keys)&&this.typeTree.checkNode(e[n].children[s],!1,!0);document.getElementById("subTypeSpan").innerHTML=0==i.length?"不限":i.join()},setSelectedStocksLi:function(t){for(var e="",i=0,n=t.length;n>i;i++)e+='<li data-code="'+t[i].code+'">'+t[i].code.match(/\d{4,6}/)[0]+"&nbsp&nbsp&nbsp&nbsp"+t[i].name+"<li>";$("#selectStocksUl").html(e)},setSecuritiesSrc:function(){var t=this,e=$("ul.subscriptionName > li.active"),i="securities.html#";e.attr("data-code")?noticeRepository.getOjbectName(e.attr("data-code")).then(function(e){for(var n=0,a=e.length;a>n;n++)e[n].code=e[n].CO,e[n].name=e[n].C4,i+=e[n].code+":"+e[n].name+",";t.setSelectedStocksLi(e),$("#stocksIframe").attr("src",i.substr(0,i.length-1))}):(t.setSelectedStocksLi([]),$("#stocksIframe").attr("src",i))},setEditorForm:function(){var t=$("ul.subscriptionName > li.active");if($("#EditorSubName").attr("value",t.text()),$("#editorTitle").val("undefined"==t.attr("data-title")?t.attr(""):t.attr("data-title")),t.attr("data-dateId")&&"undefined"!=t.attr("data-dateId")){var e=parseInt(t.attr("data-dateId"));$("#subDateSelect option")[e].selected="selected";
var i=$("#bdateInput"),n=$("#edateInput");4==e?(i.val(t.attr("data-bdate")),n.val(t.attr("data-edate")),i.attr("disabled",!1),n.attr("disabled",!1)):(i.attr("disabled",!0),n.attr("disabled",!0),i.val(""),n.val(""))}else $("#subDateSelect option")[0].selected="selected";this.checkTypeTreeNode(),this.setSecuritiesSrc()},changeEditorSubName:function(){$("#userSubUL >li.active")[0].innerHTML=$("#EditorSubName").val()},changeEditorTitle:function(){$("#editorTitle").val()&&void 0!=$("#editorTitle").val()?$("#userSubUL >li.active").attr("data-title",$("#editorTitle").val()):$("#userSubUL >li.active").removeAttr("data-title")},changeDateSelect:function(){var t=$("#userSubUL >li.active");t.attr("data-dateId",$("#subDateSelect").val()),4!=parseInt($("#subDateSelect").val())?($("#bdateInput").attr("disabled",!0),$("#edateInput").attr("disabled",!0),$("#bdateInput").val(""),$("#edateInput").val("")):($("#bdateInput").attr("disabled",!1),$("#edateInput").attr("disabled",!1),t.attr("data-bdate",$("#bdateInput").val()),t.attr("data-edate",$("#edateInput").val()))},changeBdateInput:function(){$("#userSubUL >li.active").attr("data-bdate",$("#bdateInput").val())},changeEdateInput:function(){$("#userSubUL >li.active").attr("data-edate",$("#edateInput").val())},onSelectedStocksConfirmClick:function(){var t=$("#stocksIframe")[0].contentWindow.selectedItems;if(t.length>200)$("#pointDialog").widget("dialog").show();else{for(var e=[],i=0,n=t.length<200?t.length:200;n>i;i++)e.push(t[i].code);$("#userSubUL >li.active")[0].setAttribute("data-code",e.join()),this.setSelectedStocksLi(t),$("#objectDialog").hide()}},onSubCancelBtnClick:function(){this.hide()},onShowObjectDialogClick:function(){$("#objectDialog").widget("dialog").show()},onPointConfirmClick:function(){$("#pointDialog").widget("dialog").hide()},onFilterInit:function(t){var e=t.target.widget,i=e.target,n=function(){this.val("")}.bind(i);e.on("select",function(t){this.emit("filterChange",{code:t.dataset.id,name:t.innerText.replace(/^\S+\s/,"")})}.bind(this)).on("select",n),i.on({focus:n,blur:n,input:function(t){var e=t.target.value.trim();e?(this.emit("filterInput",e.toUpperCase()),this.activeFilter=t.target.widget):t.target.widget.render([])}.bind(this)})},onFilterChange:function(t){var e=$("ul.subscriptionName > li.active");e.attr("data-code")&&e.attr("data-code").length>0?-1==e.attr("data-code").indexOf(t.code)&&e.attr("data-code",e.attr("data-code")+","+t.code):t.code&&e.attr("data-code",t.code),this.setSecuritiesSrc(),console.log("subscrioption_dialog onFilterChange")}})}),define("views/index",["./_base","../presenters/index","./widgets/grid","./widgets/confirm_dialog","./widgets/search_dialog","./widgets/tree_dialog","./widgets/favorites_dialog","./widgets/subscription_dialog"],function(t,e,i,n,a,s,r,o){var d=t.extend(function(){this.root.on("init","input[type=search]",this.onFilterInit.bind(this));var t=$(".flex-none input[type=text]");$(".flex-none input[type=text]").keyup(function(t){13===t.which&&$(this.parentNode.parentNode).find("a:eq(0)").click()}),t.next().click(function(t){$(this.parentNode.parentNode).find("a:eq(0)").click(),t.stopPropagation()}),/type=financial/.test(location.search)&&(this.form.find("input").prop({type:"text",placeholder:"请输入标题关键字"}),this.form.find("#formCode").css("display","none"))},{onTreeNodesClick:function(t,e,i){this.grid.changeHandle(i),i.keys||i.name.indexOf("最新公告")>-1||i.subId||i.objCode?this.emit("treeNodesClick",i):i.children?this.tree.expandNode(i):this.emit("treeNodesClick"),this.form.find("input").val("").removeAttr("data-id")},onFirstBtnClick:function(){this.emit("pagerChange",1)},onLastBtnClick:function(){this.emit("pagerChange",this.pager.find("input").attr("max"))},onPrevBtnClick:function(){this.emit("pagerChange",Number(this.pager.find("input").val())-1)},onNextBtnClick:function(){this.emit("pagerChange",Number(this.pager.find("input").val())+1)},onArticleLinkClick:function(){this.loadingArticle(),this.contentSplitter.is(":visible")?(this.contentSplitter.removeClass("flex-splitter-hide").show(),this.contentPanel.removeClass("flex-none-hide")):this.articleDialog.show()},onPrevArticleLinkClick:function(){this.loadingArticle()},onNextArticleLinkClick:function(){this.loadingArticle()},onChangeSizeBtnClick:function(t){$(t.target).addClass("active").siblings("a").removeClass("active").parents("article").css("font-size",t.target.dataset.size+"px")},onChangeViewBtnClick:function(t){this.contentSplitter.is(":visible")?(this.contentSplitter.hide().addClass("flex-splitter-hide"),this.contentPanel.addClass("flex-none-hide"),this.articleDialog.target.find(">.dialog-body").append(this.articlePanel),this.articleDialog.show(),$(t.target).find(">.fa").removeClass("fa-d003").addClass("fa-d004")):(this.contentSplitter.removeClass("flex-splitter-hide").show(),this.contentPanel.append(this.articlePanel).removeClass("flex-none-hide"),this.articleDialog.hide(),$(t.target).find(">.fa").removeClass("fa-d004").addClass("fa-d003"))},onSearchBtnClick:function(t){var e=this.tree.getSelectedNodes()[0];e&&(e.itemId?t.target.dataset.itemId=e.itemId:e.keys?t.target.dataset.itemId=e.keys:t.target.hasAttribute("data-item-id")&&t.target.removeAttribute("data-item-id"),e.objCode&&"undefined"!=e.objCode?t.target.dataset.objCode=e.objCode:t.target.hasAttribute("data-obj-code")&&t.target.removeAttribute("data-obj-code"),e.titleKey&&"undefined"!=e.titleKey?t.target.dataset.titleKey=e.titleKey:t.target.hasAttribute("data-title-key")&&t.target.removeAttribute("data-title-key"),e.bdate&&"null"!=e.bdate?t.target.dataset.bdate=e.bdate:t.target.hasAttribute("data-bdate")&&t.target.removeAttribute("data-bdate"),e.edate&&"null"!=e.edate?t.target.dataset.edate=e.edate:t.target.hasAttribute("data-edate")&&t.target.removeAttribute("data-edate")),$(t.target.parentNode).find("input").attr("data-id")?t.target.dataset.objCode=$(t.target.parentNode).find("input").attr("data-id"):e||$(t.target.parentNode).find("input").attr("data-id")?!e||e.objCode||$(t.target.parentNode).find("input").attr("data-id")||(t.target.dataset.objCode=""):t.target.dataset.objCode="",""!=$(t.target.parentNode).find("input[name='titleKey']").val()&&(t.target.dataset.titleKey=$(t.target.parentNode).find("input[name='titleKey']").val())},onAdvSearchBtnClick:function(){this.searchDialog instanceof Element&&(this.searchDialog=new a(this.searchDialog,{onChange:function(t){var e=this.searchDialog.target.find("input[name=objCode]"),i=this.searchDialog.target.find("input[name=titleKey]");this.emit("searchBtnClick",t),this.tree.cancelSelectedNode(),this.form.find("input:eq(0)").val(e.val()).attr("data-id",e.attr("data-id")),this.form.find("input:eq(1)").val(i.val())}.bind(this),onHide:function(){this.treeDialog.hide&&this.treeDialog.hide()}.bind(this)}))},onSubscriptionBtnClickAfter:function(t,e,i){this.subscriptionDialog instanceof Element&&(this.subscriptionDialog=new o(this.subscriptionDialog,{userid:e,subUserData:i,typeTreeNodes:t})),this.subscriptionDialog.show()},onChooseBtnClick:function(){if(this.treeDialog instanceof Element){var t=this.tree.getNodes(),e=[];/type=stock\b/.test(location.search)?(t[t.length-2].children.shift(),e=[t[t.length-2]].concat(t[t.length-1])):e=e.concat(t[t.length-1]),this.treeDialog=new s(this.treeDialog,{nodes:e,onChange:function(t,e){this.searchDialog.target.find("#itemId").val(t),this.searchDialog.target.find("input[name=itemId]").val(e)}.bind(this)})}this.treeDialog.show()},onFavoritesBtnClick:function(t){this.favoritesDialog instanceof Element&&(this.favoritesDialog=new r(this.favoritesDialog,{onChange:function(t){this.emit("favoritesChange",t)}.bind(this)})),this.favoritesDialog.keys=t.target.dataset.key?[t.target.dataset.key]:this.grid.getCheckedItems()},onRemoveFavoritesBtnClick:function(){this.alertDialog instanceof Element&&(this.alertDialog=new n(this.alertDialog,{onConfirm:function(){this.emit("removeFavoritesBtnClick",{keys:this.grid.getCheckedDelteItems().join(",")})}.bind(this)})),this.grid.getCheckedItems().length&&this.alertDialog.show()},onFilterInit:function(t){var e=t.target.widget,i=e.target;e.on("select",function(t){this.target.val(t.innerText.replace(/^(\S+)\s(.+)/,"$2 $1")).attr("data-id",t.dataset.id)}),i.on({focus:function(){this.val("").attr("data-id","")}.bind(i),blur:function(){!this.attr("data-id")&&this.val("")}.bind(i),keyup:function(t){13===t.which&&this.blur().parent().parent().find(">a:eq(0)").click()}.bind(i),input:function(t){var e=t.target.value.trim();e?(this.emit("filterInput",e.toUpperCase()),this.activeFilter=t.target.widget):t.target.widget.render([])}.bind(this)}).next().on("click",function(t){var e=this.results.find(">."+this.cssActive);e.length&&this.emit("select",e[0]),this.target.parent().parent().find(">a:eq(0)").click(),t.stopPropagation()}.bind(e))},onCloseBtnClick:function(t){$(t.target).parents(".dialog").widget().hide()},renderTree:function(t){this.tree=$.fn.zTree.init(this.nav,{callback:{onClick:this.onTreeNodesClick.bind(this)},view:{dblClickExpand:!1,expandSpeed:"",nameIsHTML:!0,selectedMulti:!1,showIcon:!1,showTitle:!1}},t)},renderNode:function(t){var e=this.tree.getNodeByParam("name",t);e&&document.getElementById(e.tId+"_a").click()},renderLatestCount:function(t){var e=this.tree.getNodes()[0];e.name=e.name.replace(/<b>[^<]*<\/b>/,"")+"<b>["+t+"]</b>",this.tree.updateNode(e)},renderSearchCode:function(t){this.form.find("input").val(t.replace(/\..+/,""))},renderFavoritesNode:function(t){var e=this.tree.getNodes()[0],i=e.open;this.tree.removeChildNodes(e),this.tree.addNodes(e,t.map(function(t,e){return t.index=e,t}),!i)},renderSecuritiesNode:function(t){var e=this.tree.getNodes()[2],i=e.open;this.tree.removeChildNodes(e),this.tree.addNodes(e,t,!i)},renderSubscriptionNode:function(t){var e=this.tree.getNodes()[1],i=e.open;this.tree.removeChildNodes(e),this.tree.addNodes(e,t,!i)},renderGrid:function(t){this.grid=this.grid||new i({target:this.container});var e="";this.tree&&0!=this.tree.getSelectedNodes().length&&(e=this.tree.getSelectedNodes()[0].parentTId),this.grid.render(t,e)},renderPager:function(t,e){this.pager.find("input").attr("max",e).val(t),this.pager.find("label").text("/ "+e),this.pager.find("a").eq(1)[1===t?"addClass":"removeClass"]("btn-disable"),this.pager.find("a").eq(2)[t===e?"addClass":"removeClass"]("btn-disable")},renderFilterResults:function(t){this.activeFilter.render(t)},renderArticle:function(t){this.articlePanel.find(">h1").text(t.C3),this.articlePanel.find(">h2>span").text(t.C2.substr(0,8).replace(/^(\d{4})(\d\d)(\d\d)/,"$1-$2-$3")),this.articlePanel.find(">h2>a[data-bind=onFavoritesBtnClick]").attr("data-key",t.CV+"#"+t.TYPE),"NULL"===t.C7?this.articlePanel.find("section").eq(0).find(">p").hide():this.articlePanel.find("section").eq(0).find(">p").html((t.C7.toLowerCase().match(/[^,]+/g)||[]).map(function(t,e){return'<a data-bind="onAttachmentLinkClick" data-key="'+this.CV+'" data-index="'+e+'"><i class="icon-'+t+'"></i>附件'+(e+1)+"</a> "},t).join("")).show(),this.articlePanel.find("section").eq(1).html(t.detail.C2.replace(/<\/?body>/g,"")),this.articlePanel.show()},loadingArticle:function(){this.articlePanel.hide()},renderAttachment:function(t,e){if(t.detail&&"NULL"!==t.detail.C3){var i=(t.detail.C3.match(/[^,]+/g)||[]).map(function(t,e){return"dzh://FILEMGR?OPEN=1&SHOWUI=1&LINK="+t+"&FILE="+this.C3+"(附件"+(e+1)+")"}.bind(t)).filter(function(t,e){return isNaN(this)||e==this}.bind(e)),n=function(){if(this.i<this.length){var t=this[this.i++];external.download?external.download(t):alert(t)}else clearInterval(this.id),this.length=0}.bind(i);i.i=0,i.id=setInterval(n,500),n()}},renderSearchDialog:function(t){this.searchDialog.renderRangeSelect(t),this.searchDialog.show()},renderFavoritesDialog:function(t){this.favoritesDialog.keys.length&&this.favoritesDialog.render(t).show()},changeFavoritesNode:function(t,e){var i=this.tree.getNodes()[0].children[t];i.keys=e,this.tree.updateNode(i),$("#"+i.tId+"_a").click()},connectSubData:function(){var t="[";return $("#userSubUL >li").map(function(e,i){t+='{"name":"'+i.innerHTML+'"',i.getAttribute("data-typeKeys")&&(t+=',"itemId":"'+i.getAttribute("data-typeKeys")+'"'),i.getAttribute("data-title")&&(t+=',"titleKey":"'+i.getAttribute("data-title")+'"'),i.getAttribute("data-dateId")&&(t+=',"dateId":"'+i.getAttribute("data-dateId")+'"',parseInt(i.getAttribute("data-dateId"))&&(t+=',"bdate":"'+i.getAttribute("data-bdate")+'"',t+=',"edate":"'+i.getAttribute("data-edate")+'"')),i.getAttribute("data-code")&&(t+=',"objCode":"'+i.getAttribute("data-code")+'"'),t+="},"}),t="["==t?"[]":t.substr(0,t.length-1)+"]",{value:t}},onSubConfirmBtnClick:function(){console.log("onSubConfirmBtnClick");var t=this.connectSubData();"0"==$("#userSubUL").attr("data-id")?this.emit("insetSubDataClick",t):this.emit("updateSubDataClick",{dataId:$("#userSubUL").attr("data-id"),value:t}),this.subscriptionDialog.hide()},onSubRemoveBtnClick:function(){if($("#userSubUL").attr("data-id")){var t=this.connectSubData();this.emit("updateSubDataClick",{dataId:$("#userSubUL").attr("data-id"),value:t})}}});return d.init=function(){new e(new this({root:$(document),nav:$("#navTree"),form:$("form.flex-none"),container:$(".grid"),pager:$(".pager"),articlePanel:$("#articlePanel"),contentPanel:$("#contentPanel"),contentSplitter:$(".flex-splitter-bottom"),searchDialog:document.querySelector("#searchDialog"),favoritesDialog:document.querySelector("#favoritesDialog"),alertDialog:document.querySelector("#alertDialog"),treeDialog:document.querySelector("#treeDialog"),articleDialog:$("#articleDialog").widget("dialog"),subscriptionDialog:document.querySelector("#subscriptionDialog")}));var t=location.href.split("?")[0]+"?type=",i=$(".notice-sort >a");i[0].href=t+"stock",i[1].href=t+"stock_hk",i[2].href=t+"bond",i[3].href=t+"fund"},d}),define("presenters/securities",["./_base","../repositories/notice","../repositories/securities"],function(t,e,i){return t.extend(function(){this.view.on("init",this.onInit.bind(this)),this.view.on("treeNodesClick",this.onTreeNodesClick.bind(this)),this.view.on("addAllBtnClick",this.onAddAllBtnClick.bind(this)),this.view.on("addSelectedBtnClick",this.onAddSelectedBtnClick.bind(this)),this.view.on("removeSelectedBtnClick",this.onRemoveSelectedBtnClick.bind(this)),this.view.on("removeAllBtnClick",this.onRemoveAllBtnClick.bind(this)),this.view.on("filterInput",this.onFilterInput.bind(this)),this.view.on("filterChange",this.onFilterChange.bind(this)),addEventListener("popstate",this.onPopState.bind(this))},{onInit:function(){this.view.renderTree(i.getSecuritiesTreeStore()),this.sourceItems=[],this.targetItems=[],this.onPopState(),window.selectedItems=this.targetItems},onTreeNodesClick:function(t){var e=t.code+"-"+t.id;this.lock!==e&&(this.lock=e,this.promise&&this.promise.cancel(),this.timeoutId=setTimeout(function(){this.view.loadingTable()}.bind(this),100),t.did?(this.promise=i.getTreeNodes(t.did,t.code,!0),this.cast=function(t){return{code:t.CO,name:t.C8}}):(this.promise=i.getBlockInfo(t.name),this.cast=function(t){return{code:t.stockid,name:t.stockname}}),this.sourceItems=[],this.promise.then(function(t){clearTimeout(this.timeoutId),t.forEach(function(t){t=this.cast(t),this.sourceItems.push(t),this.sourceItems[t.code]=t},this),this.view.renderSourceTable(this.sourceItems)}.bind(this),function(){clearTimeout(this.timeoutId),this.view.renderSourceTable(this.sourceItems)}.bind(this)))},onAddAllBtnClick:function(){this.onAddSelectedBtnClick({keys:this.sourceItems.map(function(t){return t.code}).join(",")})},onAddSelectedBtnClick:function(t){t.keys&&(t.keys.split(",").forEach(function(t){if(!(t in this.targetItems)&&t in this.sourceItems){var e=this.sourceItems[t];this.targetItems.push(e),this.targetItems[t]=e}},this),this.view.renderTargetTable(this.targetItems))},onRemoveSelectedBtnClick:function(t){if(t.keys){var e={},i=this.targetItems.length;for(t.keys.split(",").forEach(function(t){this[t]=!0},e);i--;){var n=this.targetItems[i].code;n in e&&(delete this.targetItems[n],this.targetItems.splice(i,1))}this.view.renderTargetTable(this.targetItems)}},onRemoveAllBtnClick:function(){this.clearTargetItems(),this.view.renderTargetTable(this.targetItems)},onFilterInput:function(t){i.getSecurities(t,this.type).then(function(t){for(var e=[],i=0,n=t.length;n>i;i++)e.push({id:t[i]["bond"===this.type?"trcode":"obj"],name:t[i].obj.replace(/\..+$/,"　")+t[i].disp});this.view.renderFilterResults(e)}.bind(this))},onFilterChange:function(t){t.code in this.targetItems||(this.targetItems.push(t),this.targetItems[t.code]=t),this.view.renderTargetTable(this.targetItems)},onPopState:function(){var t=decodeURI(location.hash.replace("#",""));this.clearTargetItems(),(t?t.split(","):[]).forEach(function(t){t=t.split(":"),t[0]in this||(t={code:t[0],name:t[1]},this.push(t),this[t.code]=t)},this.targetItems),this.view.renderTargetTable(this.targetItems)},clearTargetItems:function(){this.targetItems.length=0;for(var t in this.targetItems)delete this.targetItems[t]}})}),define("views/securities",["./_base","../presenters/securities"],function(t,e){return $.extend(t.extend(function(){this.root.on("init","input[type=search]",this.onFilterInit.bind(this)),this.root.find("table").on("click","tbody>tr",this.onItemClick.bind(this)).on("dblclick","tbody>tr",this.onItemDblClick.bind(this))},{onTreeNodesClick:function(t,e,i){!i.isParent&&this.emit("treeNodesClick",i)},onItemClick:function(t){var e=$(t.currentTarget),i=e.parent(),n=i[0].last||i.find(">tr:first-child");if(t.shiftKey){if(n.length&&/on/.test(n[0].className)){var a=i.children(),s=a.length,r=a.length;i.css("visibility","hidden"),a.each(function(t){(this===e[0]||this===n[0])&&(r=t>s?t:e[0]===n[0]?t:r,s=t>s?s:t),$(this)[t>=s&&r>=t?"addClass":"removeClass"]("on")}),i.css("visibility","visible")}}else!t.ctrlKey&&i.find(">tr.on").removeClass("on"),e.toggleClass("on").length&&/on/.test(e[0].className)&&(i[0].last=e)},onItemDblClick:function(t){this.emit("addSelectedBtnClick",{keys:t.currentTarget.dataset.code})},onAddSelectedBtnClick:function(t){t.currentTarget.dataset.keys=this.sourceTable.find(">.on").toArray().map(function(t){return t.dataset.code})},onRemoveSelectedBtnClick:function(t){t.currentTarget.dataset.keys=this.targetTable.find(">.on").toArray().map(function(t){return t.dataset.code})},onFilterInit:function(t){var e=t.target.widget,i=e.target,n=function(){this.val("")}.bind(i);e.on("select",function(t){this.emit("filterChange",{code:t.dataset.id,name:t.innerText.replace(/^\S+\s/,"")})}.bind(this)).on("select",n),i.on({focus:n,blur:n,input:function(t){var e=t.target.value.trim();e?(this.emit("filterInput",e.toUpperCase()),this.activeFilter=t.target.widget):t.target.widget.render([])}.bind(this)})},renderTree:function(t){this.tree=$.fn.zTree.init(this.tree,{async:{enable:!0},callback:{onQuery:function(t,e){return this.query(e)}.bind(t),onClick:this.onTreeNodesClick.bind(this)},view:{dblClickExpand:!0,expandSpeed:"",nameIsHTML:!0,selectedMulti:!1,showIcon:!1,showTitle:!1}})},renderFilterResults:function(t){this.activeFilter.render(t)},renderSourceTable:function(t){this.sourceCounter.html(t.length),this.renderTable(this.sourceTable,t,function(t,e){t.push('<tr data-code="',e.code,'" data-name="',e.name,'">',"<td>",this.fixCode(e.code),"</td>","<td>",e.name,"</td>","</tr>")}.bind(this))},renderTargetTable:function(t){var e={},i=this.targetTable.parent();this.targetCounter.html(t.length),this.targetTable.remove().children().each(function(){this.dataset.code in t?e[this.dataset.code]=!0:$(this).remove()}),this.renderTable(this.targetTable,t.filter(function(t){return!(t.code in this)},e),function(t,e){t.push('<tr data-code="',e.code,'" data-name="',e.name,'">',"<td>",this.fixCode(e.code),"</td>","<td>",e.name,"</td>","</tr>")}.bind(this),this.targetTable.children().length),i.append(this.targetTable),e=void 0,t=void 0},renderTable:function(t,e,i,n,a){var s=0,r=e.length,o=n||0,d=o>15?r:100,c=[],h=function(){for(var n=0;r>s&&d>n;)i(c,e[s],s+o),s++,n++;100>=s?(d=r,t[0].parentNode.parentNode.scrollTop=0,r+o?r&&t.parent().append(t.remove()[o?"append":"html"](c.join(""))):t.parent().append(t.empty())):t.parent().append(t.remove().append(c.join(""))),c.length=0,s===r?("function"==typeof a&&a(),delete t[0].requestId):t[0].requestId=requestAnimationFrame(h)};t[0].requestId&&(cancelAnimationFrame(t[0].requestId),delete t[0].requestId),t[0].requestId=requestAnimationFrame(h)},loadingTable:function(){var t=this.sourceTable.parent().parent().height(),e=this.sourceTable.prev().children().children().length;this.sourceTable.html(['<tr><td class="loading" height="',t,'" colspan="',e,'">Loading...</td></tr>'].join(""))},fixCode:function(t){return t.replace(/^(..)([^\.]+).+$/,"$2.$1")}}),{init:function(){new e(new this({root:$(document),tree:$("#securitiesTree"),sourceTable:$("tbody:eq(0)"),targetTable:$("tbody:eq(1)"),sourceCounter:$("b>span:eq(0)"),targetCounter:$("b>span:eq(1)")}))}})}),require(["views/index","views/securities"],function(){require(["views/"+(location.pathname.match(/([^\/]+)\.html/)||[,"index"])[1]],function(){arguments[0]&&arguments[0].init&&arguments[0].init()})}),define("src",function(){});