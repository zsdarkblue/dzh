define(["dialog","ztree"],function(a){return a.extend(function(c,b){arguments.callee.uuid=arguments.callee.uuid||0;this.select=this.target.find("select[data-option]").on("change",this.onFiltersChange.bind(this));this.ranges=this.target.find("input[type=number]").on("change",this.onFiltersChange.bind(this));this.checkboxes=this.target.find("input[type=checkbox]").on("change",this.onCheckboxesChange.bind(this));this.buttons=this.target.find("button").on("click",this.onButtonsClick.bind(this));this.tree=this.target.find(".ztree").attr("id","ztree"+arguments.callee.uuid++);this.minYear=this.ranges[0].min||this.minYear;this.maxYear=this.ranges[1].max||this.maxYear;this.ranges.attr("min",this.minYear).attr("max",this.maxYear);this.value=[];this.key=location.pathname+"#"+this.tree.attr("id")},{minYear:1990,maxYear:new Date().getFullYear(),init:function(){this.state=JSON.parse(sessionStorage.getItem(this.key));if(this.state){this.select.val(this.state.select);this.state.ranges.forEach(function(c,b){this.ranges[b].value=c},this);this.state.checkboxes.forEach(function(c,b){this.checkboxes[b].checked=!!c},this)}this.onFiltersChange();this.state&&this.ztree.getNodesByFilter(function(b){!b.checked&&b.tId.replace(this.tree.attr("id")+"_","") in this.state&&this.ztree.checkNode(b,true,false)}.bind(this))},onFiltersChange:function(){var b=this.select.val();switch(b){case"0":this.min=this.ranges[0].value;this.max=this.ranges[1].value;break;case"-1":this.min=this.minYear;this.max=this.maxYear;break;case"":this.min="";this.max="";break;default:this.min=this.maxYear-(b-1);this.max=this.maxYear;break}if(this.min!==""&&this.min<this.minYear){this.min=this.minYear}if(this.max!==""&&this.max>this.maxYear){this.max=this.maxYear}this.ztree&&this.ztree.destroy();this.render()},onCheckboxesChange:function(b){this.ztree.getNodesByParam("name",$(b.target).next().text()).forEach(function(c){c.checked=b.target.checked;this.ztree.updateNode(c,true)},this)},onTreeNodesChange:function(d,b,c){if(!c.children&&!c.checked){this.checkboxes.each(function(){if($(this).next("span").text()===c.name){this.checked=false}})}},onButtonsClick:function(b){if($(b.target).next().length){this.value.length=0;this.state={select:this.select.val(),ranges:this.ranges.toArray().map(function(c){return c.value}),checkboxes:this.checkboxes.toArray().map(function(c){return c.checked?1:0})};this.ztree.getNodes().forEach(function(c){["12-31","09-30","06-30","03-31"].forEach(function(d,e){if(this[1].children[e].checked&&this[0].value.push(this[1].name+"-"+d)){this[0].state[this[1].children[e].tId.replace(this[0].tree.attr("id")+"_","")]=1}},[this,c])},this);sessionStorage.setItem(this.key,JSON.stringify(this.state));this.emit("change")}this.hide()},render:function(){this.ranges.prop("disabled",false);this.ranges[0].value=this.min;this.ranges[1].value=this.max;this.ranges.prop("disabled",this.select.val()!=="0");this.checkboxes.prop("disabled",this.min==="");this.createTree()},getTimeRange:function(){var c=[];if(this.min!==""){for(var d=Number(this.max),b=Number(this.min)-1;d>b;d--){c.push({name:d,open:1,checked:this.checkboxes[0].checked||this.checkboxes[1].checked||this.checkboxes[2].checked||this.checkboxes[3].checked,children:[{name:"年报",checked:this.checkboxes[0].checked},{name:"三季报",checked:this.checkboxes[1].checked},{name:"中报",checked:this.checkboxes[2].checked},{name:"一季报",checked:this.checkboxes[3].checked}]})}}return c},createTree:function(){this.ztree=$.fn.zTree.init(this.tree,{callback:{onCheck:this.onTreeNodesChange.bind(this)},check:{enable:true},view:{dblClickExpand:false,showIcon:false,showTitle:false}},this.getTimeRange())}})});