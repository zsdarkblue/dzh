define(["./_base","jquery","./services","dialog","select","grid"],function(base,$,services,dialog,select){var report=base.extend(function(){var me=this;this.grid=$(".grid").on("click","a[data-id]",function(e){me.showChartDialog(this.dataset)}).on("click","a[data-time]",function(e){me.showGridDialog(this.dataset)});this.form=$("form").on("change",function(e){me.onFiltersChange()});this.timeDialog=$("#time_dialog");this.chartDialog=$("#chart_dialog");this.gridDialog=$("#grid_dialog");$("body").on("click","[data-bind]",function(e){this.dataset.bind in me&&me[this.dataset.bind](this)});this.setYearRange();this.setUnit();this.onFiltersChange()},{getOptions:function(){var search=location.search;var data={obj:(search.match(/obj=([^&]*)/)||[,"SH600000.stk"])[1],pType:(search.match(/pType=([^&]*)/)||[,14])[1]};if(/&pk=/.test(search)){data.pk=search.match(/pk=([^&]*)/)[1]}if(/&pcode=/.test(search)){data.pcode=search.match(/pcode=([^&]*)/)[1]}this.form.serializeArray().forEach(function(item){data[item.name]=(item.name in data)?data[item.name]+","+item.value:item.value});return data},$i:0,yucheDialog:"",setUnit:function(){var search=location.search;if(search.match(/unit=([^&]*)/)!=null&&search.match(/unit=([^&]*)/)!=""){$("select[name=unit]").val((search.match(/unit=([^&]*)/))[1])}},onFiltersChange:function(){if(!this._filtersLock){this._filtersLock=true;this.showLoadingMsg();services.getFinancialReport(this.getOptions()).then(function(result){this._filtersLock=false;this.hideLoadingMsg();this.yucheDialog=result.bigdata.yuchedialog;this.itcode=result.sObj;var bigdata=result.bigdata.data;if(bigdata==null||bigdata==""||bigdata==undefined){$(".flex-auto").html('<div class="no_data_msg">提示：该品种无此项记录，或在当前筛选条件下无数据</div>');return false}if(this.$i==0){this.loadBasic(result);this.$i=1}this.buildGrid(bigdata,this.addFormatters(result.bigdata.columns))}.bind(this),function(){this._filtersLock=false;this.hideLoadingMsg()}.bind(this))}},addFormatters:function(columns){for(var i=0,l=columns.length;i<l;i++){var column=columns[i];if(column.field==="title"){column.formatter=this.chartDialogFormatter}else{if(column.field.indexOf("Y")>-1){column.formatter=this.gridDialogFormatter}}}return columns},buildGrid:function(data,columns){var dataview=new Slick.Data.DataView();dataview.yucheDialog=this.yucheDialog;this.slick=buildGrid(this.grid,data,columns,{frozenColumn:0,isCollapsing:true,resize:true},dataview)},resetGrid:function(){location.reload()},exportGrid:function(){services.getExportUrl(services.getFinancialReportUrl($.extend(this.getOptions(),{type:"aja"})))},sortGrid:function(){var columns=this.slick.getColumns();var cols=[];var tempCols=[];var column=1;for(var i=0;i<column;i++){cols[i]=columns[i]}for(var j=column,k=0;j<columns.length;j++,k++){tempCols[k]=columns[j]}tempCols.reverse();var n=cols.length;for(var m=0;m<tempCols.length;m++,n++){cols[n]=tempCols[m]}this.buildGrid(this.slick.getData().getItems(),cols)},roundGrid:function(target){var input=$(target).parent().find(">input[type=hidden]").eq(0),value=input.val();if(/^[+-]/.test(target.dataset.value)){input.val(Math.min(Math.max(eval(value+target.dataset.value),0),6))}else{input.val(target.dataset.value)}input.val()!==value&&input.trigger("change")},setYearRange:function(type){var tpl1=[],tpl2=[],min=2000,max=new Date().getFullYear();var i=0;while(max>=min){var temp='<option value="'+max+'">'+(max--)+"</option>";var temps=temp;if(i==3){temps=temp.replace("<option","<option selected")}tpl1.push(temp);tpl2.push(temps);i++}if(type=="SOULENCE"){$("select[name=yearsstart]").html(tpl2.join(""));$("select[name=yearsend]").html(tpl1.join(""))}else{this.timeDialog.find("#year-end").html(tpl1.join(""));this.timeDialog.find("#year-start").html(tpl2.join(""))}},changeYears:function(target){var input=this.form.find("input[name=years]"),value=input.val();if("value" in target.dataset){$(target).addClass("btn-blue").siblings().removeClass("btn-blue");input.val(target.dataset.value)}else{var range=this.timeDialog.find("select"),min=range.eq(0).val(),max=range.eq(1).val();if(min>max){input.val(max+","+min)}else{input.val(min+","+max)}}input.val()!==value&&input.trigger("change");this.hideDialog(target)},chartDialogFormatter:function(row,cell,value,column,item){var items=this.getItems();var spacer="<span style='display:inline-block;height:1px;width:"+(15*item.indent)+"px'></span>";var bond_str="";var spance=parseInt(item.spance,10);var danwei=item.danwei;var str_dw="";if(danwei!=undefined){str_dw='data-dwunit="'+parseInt(danwei)+'"'}var link='<a data-id="'+item.distg+'" '+str_dw+' style="position:absolute;right:5px" href="javascript:;"><i class="icon-popup"></i></a>';value=value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");if(item.bond=="1"){}if(items[row+1]&&items[row+1].indent>item.indent){spance=((spance-1)<0)?0:(spance-1);if(item._collapsed){return spacer+" <span class='toggle expand' style='position:relative;left:"+spance+"em;'></span>&nbsp;<span style=\"position:relative;left:"+spance+"em;"+bond_str+'" id="row'+row+'">'+value+"</span>"+link}else{return spacer+" <span class='toggle collapse' style='position:relative;left:"+spance+"em;'></span>&nbsp;<span style=\"position:relative;left:"+spance+"em;"+bond_str+'" id="row'+row+'">'+value+"</span>"+link}}else{if(item.distg=="0"){return spacer+'<span style="position:relative;left:'+spance+"em;"+bond_str+'">'+value+"</span>"}else{return spacer+'<span style="position:relative;left:'+spance+"em;"+bond_str+'" id="row'+row+'">'+value+"</span>"+link}}},gridDialogFormatter:function(row,cell,value,column,item){var ftcode=item.distg;var dname=item.title;if(value!=null&&value!=""&&this.yucheDialog[ftcode]!=null){if(ftcode=="SOULENCE"){ftcode=value;value="点击浏览"}var dttime=column.name;return'<a data-ftcode="'+ftcode+'" data-time="'+dttime+'"  data-name="'+dname+'" href="javascript:;" style="text-decoration:underline">'+value+"</a>"}else{if(value!=null&&value!=""&&this.yucheDialog[value]!=undefined){if(this.yucheDialog[value].indexOf("SOULENCE")>-1){var typety;var items=this.getItems();for(var xx in item){if(item[xx]==value+""){typety=items[0][xx]}}ftcode=value;value="点击浏览";var dttime=column.name;return'<a data-ftcode="'+ftcode+'" data-typety="'+typety+'" data-time="'+dttime+'"  data-name="'+dname+'" href="javascript:;" style="text-decoration:underline">'+value+"</a>"}}return value}},getHrefHtml:function(column,ftcode,dname,value){var dttime=column.name;return'<a data-ftcode="'+ftcode+'" data-time="'+dttime+'"  data-name="'+dname+'" href="javascript:;" style="text-decoration:underline">'+value+"</a>"},showChartDialog:function(){this.chartDialog.find("iframe").one("load",function(){this.style.visibility="visible"}).css("visibility","hidden").attr("src",services.getFinancialChartUrl($.extend(this.getOptions(),arguments[0]))).end().widget("dialog").show()},showGridDialog:function(e){this.gridDialog.find("iframe").one("load",function(){this.style.visibility="visible"}).css("visibility","hidden").attr("src",services.getFinancialForecastUrl($.extend(this.getOptions(),arguments[0],{obj:this.itcode}))).end().widget("dialog").show()},showTimeDialog:function(target){$(target).addClass("btn-blue").siblings().removeClass("btn-blue");this.timeDialog.widget("dialog").show({left:"379px",top:"55px"})},hideDialog:function(target){$(target).parents(".dialog").widget("dialog").hide()},loadBasic:function(res){var single=eval(res.single);var baogaoqi=res.baogaoqi;var baotype=res.baotype;var baogaoqi_dis=eval(res.baogaoqi_dis);var str_tip="";if(baogaoqi_dis===false){$("#baogaoqi_dis").remove();$("select[name=tip]").remove()}else{if(parseInt(baogaoqi)>=4){str_tip+='<optgroup label="">';var kid=single?[1,2,3,4]:[4,2,1,3];for(var x in kid){var temp=((kid[x]%2==0)||single==true)?"selected='selected'":"";str_tip+='<option value="'+kid[x]+'"  '+temp+">"+baotype[(kid[x])]+"</option>"}str_tip+="</optgroup>"}if(parseInt(baogaoqi)>=5){var baotype_true=res.baotype_true;str_tip+='<optgroup label="-">';for(var i=5;i<=baogaoqi;i++){var temp_str='selected="selected"';if(baotype_true!=undefined&&baotype_true!=""&&baotype_true!=null){if($.inArray(i+"",baotype_true)===-1){temp_str=""}}str_tip+='<option value="'+i+'" '+temp_str+">"+baotype[i]+"</option>"}str_tip+="</optgroup>"}$("select[data-option=checkbox]").html(str_tip);str_tip=""}var years=eval(res.years);if(years===true){$("#years-se").html('<select name="yearsstart" data-option></select><label>至　</label><select name="yearsend" style="padding-left:5px" data-option></select>');this.__proto__.setYearRange("SOULENCE")}var mulit=eval(res.mulit);if(!mulit){$("#data-sjlx").remove();$("select[name=dataType]").remove()}else{var ext_dataTable=res.ext_dataTable;var mulitTabel=res.mulitTabel;for(var x in ext_dataTable){str_tip+='<option value="'+x+'">'+mulitTabel[x]+"</option>"}$("select[name=dataType]").html(str_tip);str_tip=""}var bbtype=res.bbtype;if(bbtype.length==0){$("#bbtype").remove();$("select[name=biaotype]").remove()}else{var bbname=res.bbname;for(var x in bbtype){var temp=(x==0)?"selected='true'":"";str_tip+='<option value="'+bbtype[x]+'"  '+temp+">"+bbname[bbtype[x]]+"</option>"}$("select[name=biaotype]").html(str_tip);str_tip=""}var hvdata=res.hvdata;var hvdata_dis=eval(res.hvdata_dis);if(hvdata_dis===false){$("#hvdata_dis").remove();$("select[name=per]").remove()}else{if(hvdata.length>0){str_tip+='<option value="CNY" selected>CNY</option>';for(var x in hvdata){str_tip+='<option value="'+hvdata[x]+'">'+hvdata[x]+"</option>"}$("select[name=per]").html(str_tip);str_tip=""}}var perType=eval(res.perType);if(perType===false){$("select[name=perType]").remove()}var Ismerger=eval(res.Ismerger);if(Ismerger===true){var s2=$("#form-group-soulence2");$("#form-group-soulence1").append(s2.html());s2.remove()}var unit=res.unit;if(unit!=null&&unit!=""&&unit!=undefined){$("select[name=unit]").val(unit)}var Subsisting=res.Subsisting;if(Subsisting==undefined||Subsisting==null||Subsisting==""){$("#subs").remove()}$("input[name=type_jidu]").val("SOULENCE");var pcode=res.pcode;if(pcode!=undefined&&pcode!=null&&pcode!=""&&pcode.constructor==Array){var temp_name=(res.pk=="1")?"发债人名称":"担保人名称";str_tip='<div class="s_title s_gray"><div class="l_title_img" style="padding-left:5px"></div><label style="margin-right:5px">'+temp_name+'</label><select data-bind="onBondChange" data-option>';for(var x in pcode){var tmp_strs=res.pcode_true==pcode[x]["code"]?'selected="selected"':"";str_tip+='<option value="'+pcode[x]["code"]+'" '+tmp_strs+">"+pcode[x]["name"]+"</option>"}str_tip+="</select></div>";$(".flex-none").append(str_tip);str_tip="";$("select[data-bind=onBondChange]").on("change",function(e){var url=window.location.protocol+"//"+window.location.host+window.location.pathname+window.location.search;var checked_value=e.target.value;if(/&pcode=/.test(url)){window.location.href=url.replace(/pcode=([^&]*)/,"pcode="+checked_value)}else{window.location.href=url+"&pcode="+checked_value}})}$("form.s_title").show();select.init()}});report.init=function(){return new report()};return report});