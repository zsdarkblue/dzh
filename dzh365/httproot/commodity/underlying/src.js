define("repositories/commodity",["repository_base"],function(t){return new(t.extend({getInfo:function(t,e){return 1===arguments.length&&(e=t,t="new,lastclose"),$.send("/objinfo/getinfo",{field:t,where:"obj="+e})},getDid:function(t,e,i){return $.send("/did",{did:t,field:e,where:"obj="+i})},getQuotes:function(t,e,i){switch(arguments.length){case 1:i=t,e="new,lastclose",t=void 0;break;case 2:i=e,e=t,t=void 0}return $.send(t?"/did?did="+t:"/quote/dyna",{field:e,where:"obj="+i,response_mode:0,response_times:-1})},getUnderlyingSecurities:function(t){return $.send("/rpc",{so:"jso-ui-option.jar","function":"gw.sh.func.GetOptionCodeRequest",paraencode:"base64",parameter:btoa(JSON.stringify({objs:t}))},{before:function(t){return t&&(t.datas[0][1].head=["obj"]),t}})},getRiskFreeRate:function(t){return $.send("/rpc",{so:"jso-ui-option.jar","function":"gw.sh.func.BondRiskFreeRateRequest",paraencode:"base64",parameter:btoa(JSON.stringify({maturity:t/365,fids:"C8"}))},{before:function(t){return t&&(t.datas[0][1].head=["C5"]),t}})}}))}),define("presenters/index",["presenter_base","vue","formatter","../repositories/commodity"],function(t,e,i,n){return t.extend(function(){this.createViewModel(),this.vm.$on("filtersChange",this.onFiltersChange.bind(this)),this.view.on("tabActive",this.onTabActive.bind(this)),this.view.on("symbolBtnClick",this.onSymbolBtnClick.bind(this))},{onInit:function(){this.symbol=(location.search.match(/\bobj=([^&]*)/)||[,"SH510050.fnd"])[1],$.when(n.getInfo("name,new,lastclose,high,low,volume",this.symbol),n.getUnderlyingSecurities(this.symbol)).then(function(){this.subscribe(arguments[1]).then(function(){$.when.apply($,this.dates.map(function(t){return n.getRiskFreeRate(parseInt(t.children[0].call.days))})).then(function(){for(var t=0,e=arguments.length;e>t;t++)this.dates[t].children.forEach(function(t){t.call.rate=Number(this),t.put.rate=Number(this)},isNaN(arguments[t][0].C5)?0:arguments[t][0].C5);this.keys&&this.updateItems(this.keys.map(function(t){return{obj:t}}))}.bind(this)),this.view.renderHeader(this.vm),this.view.renderGrid(this.options),this.filterItems()}.bind(this)),this.updateViewModel(arguments[0]),n.getQuotes("new,lastclose,high,low,volume",this.symbol).progress(this.updateViewModel.bind(this))}.bind(this),function(){location.reload()}.bind(this))},onFiltersChange:function(){var t=[this.vm.price,this.vm.amount,this.vm.month].toString();t!==this.filterKey&&(this.filterKey=t,this.filterItems())},onTabActive:function(t){this.options&&(this.view.renderGrid(this.options,t),this.filterItems())},onSymbolBtnClick:function(){this.view.renderChart(this.symbol)},subscribe:function(t){return this.items=t,this.keys=this.items.map(function(t){return t.model={},t.rate=0,this.items[t.obj]=t,t.obj},this),$.when(n.getDid(100036,"underlying_stock,style,exercise_date,K,contractMultiplierUnit",this.keys),n.getInfo("new,lastclose,buyprice,sellprice,openinterest,volume",this.keys)).then(function(){this.updateItems(arguments[0]),this.updateItems(arguments[1]),this.createOptions(),n.getQuotes("new,lastclose,buyprice,sellprice,openinterest,volume",this.keys).progress(this.updateItems.bind(this)),n.getQuotes(100038,"delta,gamma,vega",this.keys).progress(this.updateItems.bind(this))}.bind(this))},createOptions:function(){this.options=[],this.dates=[],this.items.sort(function(t,e){return t.exercise_date-e.exercise_date||t.K-e.K}).forEach(function(t){var e=t.exercise_date+"-"+t.K;e in this.options||(this.options[e]={exercise_date:t.exercise_date,K:t.K,level:1},this.options.push(this.options[e])),this.options[e][1===t.style?"call":"put"]=t}.bind(this)),this.options.forEach(function(t,e){t.exercise_date!==(this.dates[0]||{}).exercise_date&&this.dates.unshift({call:{model:{}},put:{model:{}},model:{},exercise_date:t.exercise_date,contractMultiplierUnit:t.put.contractMultiplierUnit,level:0,index:e,visible:!0})&&this.vm.options.push({text:t.exercise_date.toString().replace(/^(\d{4})(\d\d)\d+/,"$1-$2"),value:t.exercise_date})}.bind(this)),this.dates.forEach(function(t,e){t.children=this.options.slice(t.index,e?this.dates[e-1].index:this.options.length),this.options.splice(t.index,0,t)},this)},checkDate:function(){var t="commodity/underlying/date";if(this.updated){var e=new Date(new Date-6e4*(new Date).getTimezoneOffset()).toJSON().slice(0,10),i=sessionStorage.getItem(t);i!==e&&(sessionStorage.setItem(t,e),i&&location.reload())}else this.updated=!0,sessionStorage.removeItem(t)},updateItems:function(t){t.length&&(this.checkDate(t),t.forEach(function(t){var e=this.items[t.obj];for(var i in t)0==t[i]||t[i]instanceof Array&&0==t[i][0]||(e[i]=isNaN(Number(t[i]))?t[i]:Number(t[i]));if(e.lastTrade=this.vm.new,e.moneyness=e.lastTrade>e.K?1===e.style?-1:1:e.lastTrade<e.K?1===e.style?1:-1:0,e.exercise_date){var n=e.exercise_date.toString().replace(/^(\d{4})(\d\d)(\d\d)/,"$1-$2-$3"),s=+new Date(n)+558e5,r=new Date;e.date=n,e.days=Math.max(0,(s+6e4*r.getTimezoneOffset()-r)/864e5),(e.new||e.lastclose)&&(e.model=this.optionPricingModel(this.vm.new,e.K,e.rate/100,e.days/365,1===e.style,e.new||e.lastclose,.5))}},this),this.view.renderGrid())},filterItems:function(){this.dates.forEach(function(t){t.children.sort(function(t,e){return Math.abs(t.K-this.vm.price)-Math.abs(e.K-this.vm.price)||e.K-t.K}.bind(this)),t.children.forEach(function(t,e){t.visible=e<this.vm.amount},this)},this),this.view.renderFilteredGrid(this.options.filter(function(t){return t.visible&&(!this.vm.month||t.exercise_date.toString().slice(0,6)===this.vm.month.toString().slice(0,6))},this))},createViewModel:function(){this.vm=new e({data:{name:"","new":"",lastclose:"",high:"",low:"",volume:"",change:"",chg:"",price:"－",amount:5,month:"",options:[{text:"全部",value:""}]},methods:{filterChange:function(){e.nextTick(function(){this.price=this.price.toString().replace(/[^.0-9]/g,"").replace(/\.(\d+)?\.*/g,".$1"),this.amount=this.amount.toString().replace(/\D/g,""),this.amount.length&&this.amount<1&&(this.amount=1),this.price>0&&this.amount>0&&this.$emit("filtersChange",this.$data)}.bind(this))},resetFilters:function(){this.price<=0&&(this.price=this.new),this.amount<=0&&(this.amount=5)}}})},updateViewModel:function(t){t.length&&(t=t[0]),this.vm.new=i.fixFloat(i.fixLastTrade(t),4),this.vm.lastclose=i.fixPrice(t.lastclose,4),this.vm.high=i.fixPrice(t.high,4),this.vm.low=i.fixPrice(t.low,4),this.vm.volume=i.fixInt(t.volume),this.vm.change=i.fixFloat(i.fixChange(t),4),this.vm.chg=i.fixPercent(i.fixChg(t)),t.name&&(this.vm.name=t.name+" "+i.fixSymbol(t.obj)),"－"===this.vm.price&&(this.vm.price=this.vm.new),this.keys&&this.updateItems(this.keys.map(function(t){return{obj:t}}))},normalDistribution:function(t){var e=1/(1+.2316419*Math.abs(t)),i=.3989423*Math.exp(-t*t*.5),n=i*e*(.3193815+e*(-.3565638+e*(1.781478+e*(-1.821256+1.330274*e))));return t>0?1-n:n},optionPricingModel:function(t,e,i,n,s,r,o){var a,h,l,u,c,d,f,m=1e-5,p=0,g=1e-6;do if(l=(Math.log(t/e)+(i+.5*Math.pow(g,2))*n)/(g*Math.sqrt(n)),u=(Math.log(t/e)+(i-.5*Math.pow(g,2))*n)/(g*Math.sqrt(n)),c=this.normalDistribution(l),d=this.normalDistribution(u),f=s?t*c-e*Math.exp(-i*n)*d-r:e*Math.exp(-i*n)*(1-d)-t*(1-c)-r,p++)if(void 0!==a||!isNaN(f)&&99!==p){if(void 0!==a&&(0>f?(g=h===2*a||0===a&&.5===h?2*h:h+.5*(h-a),a=h):g=.5*(a+h),h=g),Math.abs(f)<m)break;void 0===a&&(g-=f/(t*Math.sqrt(n)*Math.exp(-.5*Math.pow(l,2))/Math.sqrt(2*Math.PI)))}else g=o,a=0,h=g;else{if(f>=0)return{};g=o}while(200>p);return{impliedVolatility:g,delta:c-(s?0:1),gamma:Math.exp(-.5*Math.pow(l,2))/(g*t*Math.sqrt(2*Math.PI*n)),vega:t*Math.sqrt(n)*Math.exp(-.5*Math.pow(l,2))/Math.sqrt(2*Math.PI)}}})}),define("views/index",["view_base","../presenters/index","active_grid","tabs","select"],function(t,e,i){var n=t.extend(function(){this.tabs.on("active",this.onTabActive.bind(this))},{onTabActive:function(t,e){this.emit("tabActive",e)},onGridRowDblClick:function(){this.quotesGrid&&this.quotesGrid.selectedOption&&this.renderChart(this.quotesGrid.selectedOption.obj)},createColumns:function(){return[{width:"75",name:"行权价",css:"blue c",sort:!0,value:function(t){return this.fixValue(t.K,2)}},{width:"75",name:"代码",css:"blue c",sort:!0,value:function(t){return t=t[this.type],'<a href="dzh://VIEWSTOCK?DATATYPE=DAY&LAYOUT=Level2默认&PAGE=分时走势&LABEL='+t.obj+'">'+this.fixSymbol(t.obj)+"</a>"}},{width:"65",name:"买价",color:function(t){return t=t[this.type],this.fixColor(this.fixChange(t),4)},sort:!0,value:function(t){return t=t[this.type],this.fixValue(t.buyprice instanceof Array?t.buyprice[0]:t.buyprice,4)}},{width:"65",name:"卖价",color:function(t){return t=t[this.type],this.fixColor(this.fixChange(t),4)},sort:!0,value:function(t){return t=t[this.type],this.fixValue(t.sellprice instanceof Array?t.sellprice[0]:t.sellprice,4)}},{width:"65",name:"最新",color:function(t){return t=t[this.type],this.fixColor(this.fixChange(t),4)},sort:!0,value:function(t){return t=t[this.type],this.fixValue(this.fixLastTrade(t),4)}},{width:"65",name:"涨幅%",color:function(t){return t=t[this.type],this.fixColor(this.fixChange(t),4)},sort:!0,value:function(t){return t=t[this.type],this.fixFloat(this.fixChg(t))}},{width:"75",name:"持仓量",sort:!0,value:function(t){return t=t[this.type],this.fixInt(t.openinterest)}},{width:"75",name:"成交量",sort:!0,value:function(t){return t=t[this.type],this.fixInt(t.volume)}},{width:"65",name:"隐波%",sort:!0,value:function(t){return t=t[this.type],this.fixFloat(100*t.model.impliedVolatility)}},{width:"70",name:"Delta",sort:!0,value:function(t){return t=t[this.type],this.fixFloat(t.model.delta,4)}},{width:"70",name:"Gamma",sort:!0,value:function(t){return t=t[this.type],this.fixFloat(t.model.gamma,4)}},{width:"70",name:"Vega",sort:!0,value:function(t){return t=t[this.type],this.fixFloat(t.model.vega,4)}},{width:"75",name:"有效杠杆",sort:!0,value:function(t){return t=t[this.type],this.fixFloat(t.model.delta*t.lastTrade/this.fixLastTrade(t))}},{width:"90",name:"价值状况",sort:function(t){return t=t[this.type],this.fixFloat((t.lastTrade-t.K)/t.lastTrade)},value:function(t){return t=t[this.type],0===t.moneyness?"平价":this.fixPercent(Math.abs(t.lastTrade-t.K)/t.lastTrade*100)+{"-1":"价内",1:"价外"}[t.moneyness]}}]},createColumnsT:function(){return[{width:"65",name:"买价",color:function(t){return this.fixColor(this.fixChange(t.call),4)},sort:!0,value:function(t){return this.fixValue(t.call.buyprice instanceof Array?t.call.buyprice[0]:t.call.buyprice,4)}},{width:"65",name:"卖价",color:function(t){return this.fixColor(this.fixChange(t.call),4)},sort:!0,value:function(t){return this.fixValue(t.call.sellprice instanceof Array?t.call.sellprice[0]:t.call.sellprice,4)}},{width:"65",name:"最新",color:function(t){return this.fixColor(this.fixChange(t.call),4)},sort:!0,value:function(t){return this.fixValue(this.fixLastTrade(t.call),4)}},{width:"65",name:"涨幅%",color:function(t){return this.fixColor(this.fixChange(t.call),4)},sort:!0,value:function(t){return this.fixFloat(this.fixChg(t.call))}},{width:"75",name:"持仓量",sort:!0,value:function(t){return this.fixInt(t.call.openinterest)}},{width:"65",name:"隐波%",sort:!0,value:function(t){return this.fixFloat(100*t.call.model.impliedVolatility)}},{width:"65",name:"Delta",sort:!0,value:function(t){return this.fixFloat(t.call.model.delta,4)}},{width:"75",name:"行权价",css:"blue c",sort:!0,value:function(t){return this.fixValue(t.K,2)}},{width:"65",name:"买价",color:function(t){return this.fixColor(this.fixChange(t.put),4)},sort:!0,value:function(t){return this.fixValue(t.put.buyprice instanceof Array?t.put.buyprice[0]:t.put.buyprice,4)}},{width:"65",name:"卖价",color:function(t){return this.fixColor(this.fixChange(t.put),4)},sort:!0,value:function(t){return this.fixValue(t.put.sellprice instanceof Array?t.put.sellprice[0]:t.put.sellprice,4)}},{width:"65",name:"最新",color:function(t){return this.fixColor(this.fixChange(t.put),4)},sort:!0,value:function(t){return this.fixValue(this.fixLastTrade(t.put),4)}},{width:"65",name:"涨幅%",color:function(t){return this.fixColor(this.fixChange(t.put),4)},sort:!0,value:function(t){return this.fixFloat(this.fixChg(t.put))}},{width:"75",name:"持仓量",sort:!0,value:function(t){return this.fixInt(t.put.openinterest)}},{width:"65",name:"隐波%",sort:!0,value:function(t){return this.fixFloat(100*t.put.model.impliedVolatility)}},{width:"65",name:"Delta",sort:!0,value:function(t){return this.fixFloat(t.put.model.delta,4)}}]},renderGrid:function(t,e){t?(this.quotesGrid&&this.quotesGrid.destroy(),this.quotesGrid=new(i.extend({type:{1:"call",2:"put"}[e],columns:this["createColumns"+(e?"":"T")](),items:t,onCreate:function(){this.type?this.target.css("padding-top",28):(this.mid=Math.floor(this.columns.length/2),this.target.css("padding-top",56).find("tr").before(['<tr><td colspan="',this.mid,'">认购</td><td></td><td colspan="',this.mid,'">认沽</td></tr>'].join("")))},onDblClick:this.onGridRowDblClick.bind(this),onClick:function(t,e){if(e.K){if(this.type)this.selectedOption=e[this.type];else{var i=$(t.currentTarget).children().index("TD"===t.target.tagName?t.target:$(t.target).parents("td"));this.selectedOption=i===this.mid?void 0:e[i<this.mid?"call":"put"]}this.base(arguments)}},compare:function(t){return function(t,e){return t.exercise_date-e.exercise_date||t.level-e.level||this(t,e)||t.K-e.K}.bind(this.base(t))},renderRow:function(t,e,i){var n=$(t);if(i.K){var s={"-1":"#270000",0:"transparent",1:"#0E1C00"};if(s.call=s[i.call.moneyness],s.put=s[i.put.moneyness],n.removeClass("row-group").children().eq(0).removeAttr("colspan"),this.base(arguments),this.type)n.children().css("background-color",s[this.type]);else for(var e=0,r=t.children.length;r>e;e++)e<this.mid?t.children[e].style.backgroundColor=s.call:e>this.mid&&(t.children[e].style.backgroundColor=s.put)}else n.addClass("row-group").children().eq(0).attr("colspan",this.columns.length).html([i.children[0].call.date," (",Math.floor(i.children[0].call.days),"天);　","无风险利率 ",this.fixPercent(i.children[0].call.rate)].join(""))[0].value=void 0}}))(this.grid[0])):this.quotesGrid&&this.quotesGrid.refresh(!0)},renderFilteredGrid:function(t){this.quotesGrid&&this.quotesGrid.setRows(t)},renderHeader:function(t){t.$el||(t.$mount(this.header[0]),t.$watch("options",function(){this.refresh()}.bind(this.header.find("select").widget("select"))))},renderChart:function(t){location.assign("dzh://VIEWSTOCK?DATATYPE=DAY&LAYOUT=Level2默认&PAGE=分时走势&LABEL="+t)}});return n.init=function(){new e(new this({root:$(document),header:$("header"),grid:$(".grid"),tabs:$(".nav-tabs")}))},n}),require(["views/index"],function(){require(["views/"+(location.pathname.match(/([^\/]+)\.html/)||[,"index"])[1]],function(){arguments[0]&&arguments[0].init&&arguments[0].init()})}),define("src",function(){});