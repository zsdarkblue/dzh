//>>built
define("dojox/store/WebSocket","dojo/_base/declare,dojo/_base/lang,dojo/json,dojo/Deferred,dojo/request,dojo/store/util/QueryResults,dojo/store/Memory,dojo/io-query,dojo/_base/config,dojox/websocket/WebSockets,dojox/websocket/EventSource,dojo/topic,dojo/on".split(","),function(h,e,r,i,j,k,l,m,n,o,p,q){return h("dojox.store.WebSocket",[l],{prefix:"/json/",serviceUrl:"",channel:"",idProperty:"req_seq",_keepOneRequest:!1,queryEngine:function(){return function(a){return a}},constructor:function(){this.deferreds=
{};this.rr_dic={};this.deferred_queue=[];this.handle_map={};this._response_queue=[];this.websocket=(this.remoteApp=n.remoteApp)?p.getInstance():o.getInstance()},isEmptyObject:function(a){for(var b in a)return!1;return!0},query:function(a,b){var a=a||{},c=this.isEmptyObject(a);if(!c||""!=this.serviceUrl||""!=this.channel){c=(this.remoteApp?this.serviceUrl:this.prefix+"subscribe?"+this.serviceUrl)+(""!=this.serviceUrl&&!c?"?":"");c+=decodeURIComponent(m.objectToQuery(a));if(-1==a.response_times||""!=
this.serviceUrl&&-1==a.__repeat)this._keepOneRequest=!0;for(;0<this._response_queue.length&&this._keepOneRequest;)this.cancel(this._response_queue.shift());var d=new i;this.deferred_queue.push(d);if(this.remoteApp&&this.channel)this.websocket.send(this.channel,e.hitch(this,this._onmessage));else if(this.remoteApp){var f={headers:{Accept:"application/json"}};b&&b.headers&&e.mixin(f.headers,b.headers);j(c,f).then(e.hitch(this,function(a){this._onmessage(this.websocket.parse(a))}))}else this.websocket.send(c,
e.hitch(this,this._callback));return k(d.promise)}return this.inherited(arguments)},cancel:function(a){this.remoteApp&&this.channel?this.websocket.close():(this.websocket.send(this.prefix+"cancel?"+a),this.clean(a))},clean:function(a){delete this.deferreds[a];delete this.rr_dic[a];this.handle_map[a]&&(this.handle_map[a].remove(),delete this.handle_map[a]);"req_seq"==this.idProperty&&this.remove(a)},_onmessage:function(a){var b=a.req_seq,c=a.res_seq,d=a.res_type;Number(c)>Number(this.rr_dic[b])&&0<=
d?(this.rr_dic[b]=c,a=this.progress(a),(b=this.deferreds[b])&&b.isResolved&&!b.isResolved()&&b.resolve(a)):0>d?(b=this.deferreds[b])&&b.isResolved&&!b.isResolved()&&b.resolve(this._convertErrorInfo(a)):this.remoteApp&&(b=this.deferred_queue.shift(),a=this.progress(a,b),b&&b.isResolved&&!b.isResolved()&&b.resolve(a));if(!1==this._keepOneRequest){a=[];b=0;for(c=this._response_queue.length-1;b<c;b++)0<this.rr_dic[this._response_queue[b]]?this.cancel(this._response_queue[b]):a.push(this._response_queue[b]);
a.push(this._response_queue.pop());this._response_queue=a}},_callback:function(a){var b=this.req_seq=a.req_seq,a=a.res_seq;this.deferreds[b]=this.deferred_queue.shift();this.rr_dic[b]=a;for(this._response_queue.push(b);1<this._response_queue.length&&this._keepOneRequest;)this.cancel(this._response_queue.shift());this.handle_map[b]=q.subscribe(b,e.hitch(this,this._onmessage))},put:function(a,b){this.formatter&&this.formatter(arguments);return this.inherited(arguments)},setData:function(a){if(this.formatter)for(var b=
a.items?a.items:a,c=0,d=b.length;c<d;c++)b[c]=this.formatter([b[c]]);this.inherited(arguments)},mergeFunc:function(a,b){var c=a.get(b[this.idProperty])||{};return e.mixin(c,b)},progress:function(a,b){var c=this.convert(a),d=this.remoteApp?b:this.deferreds[a.req_seq];if(d&&d.isResolved&&d.isResolved()||this.store)if(d=this.store?this.store:this,c instanceof Array)for(var f=0,e=c.length;f<e;f++){var g=this.mergeFunc(d,c[f]);g&&d.put(g)}else(g=this.mergeFunc(d,c))&&d.put(g);else c instanceof Array?this.setData(c):
this.put(c);return c},convert:function(a){return[a]},_convertErrorInfo:function(a){var b=a.result.head,c=a.result.datas,d={};d.res_type=a.res_type;c.forEach(function(a){b.forEach(function(b,c){d[b]=a[c]})});return d}})});