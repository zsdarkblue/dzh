define("repositories/news",["repository_base"],function(t){return new(t.extend({getThemes:function(t){return $.send("/rpc",{so:"jso-ui-stockzttz.jar","function":"gw.sh.func.StockZttzListRequest",paraencode:"base64",parameter:btoa(t?JSON.stringify(t):""),cache:!0},{after:function(t){return t.length&&t[0]instanceof Array&&(t[0]._name=t[1][0].cob,t=t[0]),t._keys=[],t._dict={},t.length&&t.forEach(function(e){if(e.co){var i=e.co.split(","),n=(e.c3a||"").split(","),s=(e.c4a||"").split(","),o=(e.c5a||"").split(",");e.stocks=[];for(var r=0,h=i.length;h>r;r++){var a=i[r]+".stk";a in this._dict||(this._dict[a]={obj:a,chg:[n[r],s[r],o[r]]},t._keys.push(a)),e.stocks.push(this._dict[a])}e.coa&&e.coa.split(",").forEach(function(t){this[t+".stk"]=!0},e.stocks)}},t),t}})},getContentByTheme:function(t){return $.send("/rpc",{so:"jso-ui-stockzttz.jar","function":"gw.sh.func.StockZtContentRequest",paraencode:"base64",parameter:btoa(JSON.stringify({code:t}))})},getEventsByTheme:function(t){return $.send("/rpc",{so:"jso-ui-stockzttz.jar","function":"gw.sh.func.StockZtFutureEventRequest",paraencode:"base64",parameter:btoa(JSON.stringify({code:t}))},{before:function(t){return t&&(t.datas[0][1].head=["time","name","content"]),t}})},getNewsByStocks:function(t){return $.send("/rpc",{so:"jso-ui-zhpnews.jar","function":"gw.sh.func.MyOptionalStocksNewsRequest",paraencode:"base64",parameter:btoa(JSON.stringify({fids:"C1,C3,C16",dcategory:"1",bdate:"",edate:"",sort:"C16:-1",skip:0,amount:50,stocks:t.join(",")}))},{after:function(t){if(t&&t.length)for(var e={},i=t.length;i--;)t[i].C1 in e?t.splice(i,1):e[t[i].C1]=!0;return t}})},getNewsByTheme:function(t){return $.send("/rpc",{so:"jso-ui-stockzttz.jar","function":"gw.sh.func.StockZtNewsListRequest",paraencode:"base64",parameter:btoa(JSON.stringify({code:t}))},{before:function(t){return t&&(t.datas[0][1].head=["C1","C3","C16"]),t}})}}))}),define("repositories/stock",["repository_base"],function(t){return new(t.extend({getInfo:function(t,e){return $.send("/objinfo/getinfo",{field:t,where:"obj="+e})},getQuotes:function(t,e){return $.send("/quote/dyna",{field:t,where:"obj="+e,response_mode:0,response_times:-1})}}))}),define("repositories/user",["repository_base"],function(t){return new(t.extend({url:"/stock/sys/sys_user/preferdata/userPreferEntry.mod",name:"/news/themes",title:"主题投资",uid:external.getDZHProperty?external.getDZHProperty("userid"):"dzh127_007",getApp:function(){if(!arguments.callee.promise){var t=$.Deferred();$.send(this.url,{action:"select",type:"appdic",name:this.name}).then(function(e){e[0].resultcode?$.send(this.url,{action:"insert",type:"appdic",name:this.name,title:this.title}).then(function(e){t.resolve(e[0])}.bind(this)):t.resolve(e[0])}.bind(this)),arguments.callee.promise=t}return arguments.callee.promise},getFavorites:function(){var t=$.Deferred();return this.getApp().then(function(e){$.send(this.url,{action:"query",type:"userdata",user:this.uid,appid:e.id,categoryid:0}).then(function(e){var i={keys:[]};e[0].id&&(i=JSON.parse(e[0].data)||i,i.id=e[0].id),t.resolve(i)}.bind(this))}.bind(this)),t},setFavorites:function(t){var e=$.Deferred();return this.getApp().then(function(i){t.id?$.send(this.url,{action:"update",type:"userdata",udid:t.id,appid:i.id,categoryid:0,data:JSON.stringify(t)}).then(function(t){e.resolve(t)}.bind(this)):$.send(this.url,{action:"insert",type:"userdata",user:this.uid,appid:i.id,categoryid:0,title:"收藏主题",data:JSON.stringify(t)}).then(function(t){e.resolve(t)}.bind(this))}.bind(this)),e}}))}),define("presenters/index",["presenter_base","../repositories/news","../repositories/stock","../repositories/user"],function(t,e,i,n){return t.extend(function(){this.view.on("themeFilterChange",this.onThemeFilterChange.bind(this)),this.view.on("filterInput",this.onFilterInput.bind(this)),this.view.on("themeGridSelectItem",this.onThemeGridSelectItem.bind(this)),this.view.on("showEventsBtnClick",this.onShowEventsBtnClick.bind(this)),this.view.on("showCellContextMenu",this.onShowCellContextMenu.bind(this)),this.view.on("favoritesBtnClick",this.onFavoritesBtnClick.bind(this)),this.view.on("showContentBtnClick",this.onShowContentBtnClick.bind(this))},{promises:[],filters:{},favorites:[],onInit:function(){this.stock=(location.search.match(/\bobj=([^&]*)/)||[,""])[1],this.keywords=decodeURI((location.search.match(/\bq=([^&]*)/)||[,""])[1]),this.stock?$.when(e.getThemes({stock:this.stock}),i.getInfo("name",this.stock)).then(function(){this.title=this.stock.split(".")[0]+" "+arguments[1][0].name,this.subscribe(arguments[0])}.bind(this)):e.getThemes().then(function(t){this.subscribe(t),n.getFavorites().then(function(t){this.favorites.id=t.id,t.keys.forEach(function(t){var e=t+"\f";e in this||(this.push(t),this[e]=!0)},this.favorites)}.bind(this))}.bind(this))},onThemeFilterChange:function(t){t?this.filters.favorites=function(t){return t.c2+"\f"in this}.bind(this.favorites):delete this.filters.favorites,this.filterThemes()},onFilterInput:function(t){t!==this.lastInput&&(this.lastInput=t,t?this.filters.search=function(t){return[t.c3,t.co,t.stocks.map(function(t){return t.name})].join("\n").indexOf(this)>-1}.bind(t):delete this.filters.search,this.filterThemes())},onThemeGridSelectItem:function(t){this.active!==t&&(this.active=t,this.view.renderStockGrid(t.stocks.filter(function(t){return 0!==t.name.indexOf("--")})),this.view.renderThemeNewsGrid([]),this.view.renderStockNewsGrid([]),this.promises.forEach(function(t){t.cancel()}),this.promises.length=0,this.promises.push(e.getNewsByTheme(t.c2).then(this.view.renderThemeNewsGrid.bind(this.view)),e.getNewsByStocks(t.stocks.map(function(t){return t.obj})).then(this.view.renderStockNewsGrid.bind(this.view))))},onShowEventsBtnClick:function(){e.getEventsByTheme(this.active.c2).then(this.view.renderEvents.bind(this.view))},onShowCellContextMenu:function(t){var e=t.c2+"\f";this.view.renderCellContextMenu(t,e in this.favorites)},onFavoritesBtnClick:function(t){var e=t.id+"\f";if(e in this.favorites){for(var i=this.favorites.length;i--;)if(this.favorites[i]+"\f"===e){delete this.favorites[e],this.favorites.splice(i,1);break}}else this.favorites.push(t.id),this.favorites[e]=!0;this.filters.favorites&&this.filterThemes(),n.setFavorites({id:this.favorites.id,keys:this.favorites.slice(0)})},onShowContentBtnClick:function(t){e.getContentByTheme(t.id).then(function(t,e){this.view.renderThemeContent({name:t,content:e[0].c8})}.bind(this,t.name))},subscribe:function(t){this.items=t,this.view.renderHeader(this.title,this.keywords),this.items.length&&i.getInfo("name,new,lastclose",this.items._keys).then(function(t){this.updateItems(t),this.view.renderThemeGrid(this.items),this.onFilterInput(this.keywords),i.getQuotes("new,lastclose",this.items._keys).progress(this.updateItems.bind(this))}.bind(this))},updateItems:function(t){if(this.updated){var e=new Date(new Date-6e4*(new Date).getTimezoneOffset()).toJSON().slice(0,10),i=sessionStorage.getItem("new/themes/date");i!==e&&(sessionStorage.setItem("new/themes/date",e),i&&location.reload())}else this.updated=!0,sessionStorage.removeItem("new/themes/date");t.length&&(t.forEach(function(t){var e=this.items._dict[t.obj];for(var i in t)0==t[i]||t[i]instanceof Array&&0==t[i][0]||(e[i]=isNaN(Number(t[i]))?t[i]:Number(t[i]))},this),this.view.renderQuotesGrids())},filterThemes:function(){var t=this.items;for(var e in this.filters)t=t.filter(this.filters[e]);this.view.renderFilteredThemes(t),t.length||(this.active=void 0,this.view.renderStockGrid([]),this.view.renderThemeNewsGrid([]),this.view.renderStockNewsGrid([]))}})}),define("views/index",["view_base","../presenters/index","fast_grid","active_grid","select","dialog"],function(t,e,i,n){var s=t.extend(function(){this.filter.on("input",this.onFilterInput.bind(this)),this.grids.eq(0).on("contextmenu","td:nth-of-type(2)",this.onShowCellContextMenu.bind(this)),this.menu.on("click","li",this.onContextMenuItemClick.bind(this))},{onFilterInput:function(t){this.emit("filterInput",t.currentTarget.value.trim())},onShowCellContextMenu:function(t){this.menu.css({top:t.pageY,left:t.pageX}),this.emit("showCellContextMenu",this.themeGrid.getItem(t.currentTarget.parentNode.dataset.index)),t.preventDefault()},onHideCellContextMenu:function(t){!$(t.target).closest(this.menu).length&&this.menu.hide()},onContextMenuItemClick:function(){this.menu.hide()},onShowEventsBtnClick:function(){this.renderDialog("未来事件")},onShowContentBtnClick:function(){this.renderDialog("主题简介")},onCloseDialogBtnClick:function(){this.dialog.hide()},renderHeader:function(t,e){t?this.header.children().first().html(t).css("visibility","visible"):this.header.children().first().siblings().css("visibility","visible"),e&&this.header.find("input").val(e)},renderThemeGrid:function(t){this.themeGrid=new n(this.grids[0],{columns:[{width:"47px",name:"",css:"white",value:function(t,e){return++e+")"}},{width:"200px",name:"主题",css:"l",sort:!0,value:function(t){return'<i class="fa'+(t.future>0?' fa-calendar" data-bind="onShowEventsBtnClick" title="未来事件':"")+'"></i>'+t.c3+(Number(t.c9a)?"<sup>NEW</sup>":"")+(Number(t.c8a)?"<sup>*</sup>":"")}},{width:"70px",name:"涨幅",order:"desc",color:function(t,e,i){return this.fixColor(this.parse(t,this.columns[i],e,i))},sort:!0,value:function(t){for(var e=0,i=0,n=t.stocks.length;n>i;i++){var s=t.stocks[i];e+=100*((s.new||s.lastclose)/s.lastclose-1||0)}return this.fixFloat(e/n)}},{width:"90px",name:"<select data-option><option>周涨幅</option><option>月涨幅</option><option>季涨幅</option></select>",color:function(t,e,i){return this.fixColor(this.parse(t,this.columns[i],e,i))},value:function(t){for(var e=0,i=0,n=t.stocks.length;n>i;i++){var s=t.stocks[i];e+=100*(s.chg[this.chgIndex]*((s.new||s.lastclose)/s.lastclose||1)-1)}return this.fixFloat(e/n)}},{width:"auto",name:"最新新闻",css:"white cl",sort:!0,value:function(t){return"NULL"===t.c3c?"－":"<a href=\"dzh://navigate?'root://news/details/index.html#"+t.c3c+"#DZHPOPUP(854,504)#'\">"+t.c4c+"</a>"}},{width:"50px",name:"时间",css:"white l",sort:function(t){return t.c7c},value:function(t){return this.fixTime(t.c7c)}}],items:t,chgIndex:0,onCreate:function(){this.target.find("thead")[0].addEventListener("mousedown",function(t){"SELECT"===t.target.tagName&&t.stopPropagation()},!0),this.target.find("select").on("change",function(t){this.chgIndex=t.target.selectedIndex,this.target.find("th").removeClass("asc desc"),this.sort(3,"desc"),this.changes.renderRows=!0}.bind(this)).widget("select")},onSelectItem:function(t,e){this.emit("themeGridSelectItem",e)}.bind(this),compare:function(t){return function(t,e){return this(t,e)||t.c2.localeCompare(e.c2)}.bind(this.base(t))}})},renderStockGrid:function(t){this.stockGrid?this.stockGrid.setItems(t):this.stockGrid=new n(this.grids[1],{columns:[{width:"40px",name:"",css:"white",value:function(t,e){return++e+")"}},{width:"auto",name:"成份股",css:"l",sort:!0,value:function(t){return'<a href="dzh://VIEWSTOCK?DATATYPE=DAY&LAYOUT=Level2默认&PAGE=分时走势&LABEL='+t.obj+'">'+t.name+"</a>"+(t.obj in this.items?"<sup>N</sup>":"")}},{width:"70px",name:"最新价",color:function(t){return this.fixColor(this.fixChange(t))},sort:!0,value:function(t){return this.fixValue(this.fixLastTrade(t))}},{width:"70px",name:"涨幅",color:function(t){return this.fixColor(this.fixChange(t))},sort:!0,value:function(t){return this.fixFloat(this.fixChg(t))}},{width:"90px",name:"<select data-option><option>周涨幅</option><option>月涨幅</option><option>季涨幅</option></select>",color:function(t,e,i){return this.fixColor(this.parse(t,this.columns[i],e,i))},value:function(t){return this.fixFloat(100*(t.chg[this.chgIndex]*(this.fixLastTrade(t)/t.lastclose||1)-1))}}],items:t,chgIndex:0,onCreate:function(){this.target.find("thead")[0].addEventListener("mousedown",function(t){"SELECT"===t.target.tagName&&t.stopPropagation()},!0),this.target.find("select").on("change",function(t){this.chgIndex=t.target.selectedIndex,this.target.find("th").removeClass("asc desc"),this.sort(4,"desc"),this.changes.renderRows=!0}.bind(this)).widget("select")},onDblClick:function(t){location.assign($(t.currentTarget).find("a").attr("href"))},compare:function(t){return function(t,e){return this(t,e)||t.obj.localeCompare(e.obj)}.bind(this.base(t))}})},renderFilteredThemes:function(t){this.themeGrid&&(this.themeGrid.setRows(t),t.length&&this.emit("themeGridSelectItem",this.themeGrid.getItem(0)))},renderQuotesGrids:function(){this.themeGrid&&this.themeGrid.refresh(!0),this.stockGrid&&this.stockGrid.refresh(!0)},renderNewsGrid:function(t,e,n){this.grids[e].widget||new i(this.grids[e],{columns:[{width:"auto",name:n,css:"white l",sort:!0,value:function(t){return"<a href=\"dzh://navigate?'root://news/details/index.html#"+t.C1+"#DZHPOPUP(854,504)#'\">"+t.C3+"</a>"}},{width:"50px",name:"",css:"white l",sort:!0,value:function(t){return this.fixTime(t.C16)}}],items:[]}),this.grids[e].widget.setItems(t)},renderThemeNewsGrid:function(t){this.renderNewsGrid(t,2,"主题新闻")},renderStockNewsGrid:function(t){this.renderNewsGrid(t,3,"个股新闻")},renderDialog:function(t){this.dialog.target.find(">.dialog-header>h3").html(t),this.dialog.target.find(">.dialog-body").empty().addClass("loading"),this.dialog.show()},renderEvents:function(t){var e=[];t.forEach(function(t){this.push("<article><h1>",t.name,"</h1><h2>活动日期: ",t.time.replace(/^(\d{4})(\d\d)(\d\d).+/,"$1-$2-$3"),"</h2><section>",t.content,"</section></article>")},e),this.dialog.target.find(">.dialog-body").removeClass("loading").html(e.join(""))},renderCellContextMenu:function(t,e){this.root.one("mousedown",this.onHideCellContextMenu.bind(this)),this.menu.children()[0].dataset.id=t.c2,this.menu.children()[1].dataset.id=t.c2,this.menu.children()[1].dataset.name=t.c3,this.menu.children().first().html(e?'<i class="fa fa-star"></i>取消收藏':'<i class="fa fa-star-o"></i>收藏'),this.menu.show()},renderThemeContent:function(t){this.dialog.target.find(">.dialog-body").removeClass("loading").html(["<article><h1>",t.name,"</h1><section>",t.content,"</section></article>"].join(""))}});return s.init=function(){new e(new this({root:$(document),header:$("body>header"),filter:$("input[type=search]"),grids:$(".grid"),menu:$(".tooltips"),dialog:$(".dialog").widget("dialog")}))},s}),require(["views/index"],function(){require(["views/"+(location.pathname.match(/([^\/]+)\.html/)||[,"index"])[1]],function(){arguments[0]&&arguments[0].init&&arguments[0].init()})}),define("src",function(){});