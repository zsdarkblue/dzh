(function(a){a.fn.extend({autocomplete:function(b,c){var d=typeof b=="string";c=a.extend({},a.Autocompleter.defaults,{url:d?b:null,data:d?null:b,delay:d?a.Autocompleter.defaults.delay:10,max:c&&!c.scroll?10:150},c);c.highlight=c.highlight||function(e){return e};c.formatMatch=c.formatMatch||c.formatItem;return this.each(function(){new a.Autocompleter(this,c)})},result:function(b){return this.bind("result",b)},search:function(b){return this.trigger("search",[b])},flushCache:function(){return this.trigger("flushCache")},setOptions:function(b){return this.trigger("setOptions",[b])},unautocomplete:function(){return this.trigger("unautocomplete")}});a.Autocompleter=function(l,g){var c={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8};var b=a(l).attr("autocomplete","off").addClass(g.inputClass);var j;var p="";var m=a.Autocompleter.Cache(g);var e=0;var u;var x={mouseDownOnSelect:false};var r=a.Autocompleter.Select(g,l,d,x);var w;b.bind("keydown.autocomplete",function(y){e=1;u=y.keyCode;switch(y.keyCode){case c.UP:y.preventDefault();if(r.visible()){r.prev()}else{t(0,true)}break;case c.DOWN:y.preventDefault();if(r.visible()){r.next()}else{t(0,true)}break;case c.PAGEUP:y.preventDefault();if(r.visible()){r.pageUp()}else{t(0,true)}break;case c.PAGEDOWN:y.preventDefault();if(r.visible()){r.pageDown()}else{t(0,true)}break;case g.multiple&&a.trim(g.multipleSeparator)==","&&c.COMMA:case c.TAB:case c.RETURN:if(d()){y.preventDefault();w=true;g.selecttrigger?r.getselectedli().find("div.ac_div").trigger("click"):null;return false}break;case c.ESC:r.hide();break;default:clearTimeout(j);j=setTimeout(t,g.delay);break}}).focus(function(){e++}).blur(function(){e=0;if(!x.mouseDownOnSelect){s()}}).click(function(){if(e++>=1&&!r.visible()){t(0,true)}}).bind("search",function(){var y=(arguments.length>1)?arguments[1]:null;function z(D,C){var A;if(C&&C.length){for(var B=0;B<C.length;B++){if(C[B].result.toLowerCase()==D.toLowerCase()){A=C[B];break}}}if(typeof y=="function"){y(A)}else{b.trigger("result",A&&[A.data,A.value])}}a.each(h(b.val()),function(A,B){f(B,z,z)})}).bind("flushCache",function(){m.flush()}).bind("setOptions",function(){a.extend(g,arguments[1]);if("data" in arguments[1]){m.populate()}}).bind("unautocomplete",function(){r.unbind();b.unbind();a(l.form).unbind(".autocomplete")}).bind("input",function(){t(0,true)});function d(){var B=r.selected();if(!B){return false}var y=B.result;p=y;if(g.multiple){var E=h(b.val());if(E.length>1){var A=g.multipleSeparator.length;var D=a(l).selection().start;var C,z=0;a.each(E,function(F,G){z+=G.length;if(D<=z){C=F;return false}z+=A});E[C]=y;y=E.join(g.multipleSeparator)}y+=g.multipleSeparator}b.val(y);v();b.trigger("result",[B.data,B.value]);return true}function t(A,z){if(u==c.DEL){r.hide();return}var y=b.val();if(!z&&y==p){return}p=y;y=i(y);if(y.length>=g.minChars){b.addClass(g.loadingClass);if(!g.matchCase){y=y.toLowerCase()}f(y,k,v)}else{n();r.hide()}}function h(y){if(!y){return[""]}if(!g.multiple){return[a.trim(y)]}return a.map(y.split(g.multipleSeparator),function(z){return a.trim(y).length?a.trim(z):null})}function i(y){if(!g.multiple){return y}var A=h(y);if(A.length==1){return A[0]}var z=a(l).selection().start;if(z==y.length){A=h(y)}else{A=h(y.replace(y.substring(z),""))}return A[A.length-1]}function q(y,z){if(g.autoFill&&(i(b.val()).toLowerCase()==y.toLowerCase())&&u!=c.BACKSPACE){b.val(b.val()+z.substring(i(p).length));a(l).selection(p.length,p.length+z.length)}}function s(){clearTimeout(j);j=setTimeout(v,200)}function v(){var y=r.visible();r.hide();clearTimeout(j);n();if(g.mustMatch){b.search(function(z){if(!z){if(g.multiple){var A=h(b.val()).slice(0,-1);b.val(A.join(g.multipleSeparator)+(A.length?g.multipleSeparator:""))}else{b.val("");b.trigger("result",null)}}})}}function k(z,y){if(y&&y.length&&e){n();r.display(y,z);q(z,y[0].value);r.show()}else{v()}}function f(A,E,z){if(!g.matchCase){A=A.toLowerCase()}var C=m.load(A);if(C&&C.length){E(A,C)}else{if((typeof g.url=="string")&&(g.url.length>0)){var F={timestamp:+new Date()};a.each(g.extraParams,function(G,H){F[G]=typeof H=="function"?H():H});var B=i(A);if(g.websocket){a("#histroy").remove();var y="";if(g.websocketOption==""){y=g.url+B.toUpperCase()}else{y=g.createUrlFun(B)}Socket.send(y,function(J){C=J.results;if(C==null){a(".ac_results ul").empty();return false}if(C.length!=0){var I=C,H=[];if(g.websocketOption==""){for(var G in I){H.push({data:I[G][1],value:I[G][0]})}}else{for(var G in I){H.push({data:I[G]})}}m.add(A,H);E(A,H)}else{r.emptyList();z(A)}})}else{if(typeof g.formatRequesturl=="function"){B=g.formatRequesturl(B)}if(g.ajaxfun=="getjsonstock"){a.getJSON(g.url+"?q="+B,F,function(H){if(H.responseHeader.status==0){var J=H.response.docs,G=J.length,I=[];if(G>0){a.each(J,function(L,M){var K=-1;if((K=M.id.indexOf("."))!=-1){M.id=M.id.substring(0,K)}I.push({data:M,value:M.id})});m.add(A,I);E(A,I)}else{r.emptyList();z(A)}}})}else{var D={jsonp:a.ajaxSetup().jsonp};a.ajaxSetup({jsonp:"json.wrf"});a.ajax({mode:"abort",port:"autocomplete"+l.name,dataType:g.dataType,url:g.url+"?q="+B,data:a.extend({limit:g.max},F),success:function(I){if(typeof(I)!=="string"){if(g.dataType=="jsonp"){var K=I.response.docs,H=K.length,J=[];if(H>0){a.each(K,function(L,M){if(M.id){M.id=M.id;J.push({data:M,value:M.id})}});m.add(A,J);E(A,J)}else{r.emptyList();z(A)}}else{m.add(A,I);E(A,I)}}else{var G=g.parse&&g.parse(dataHandle)||o(dataHandle);m.add(A,G);E(A,G)}}});a.ajaxSetup(D)}}}else{r.emptyList();z(A)}}}function o(B){var y=[];var A=B.split("\n");for(var z=0;z<A.length;z++){var C=a.trim(A[z]);if(C){C=C.split("|");y[y.length]={data:C,value:C[0],result:g.formatResult&&g.formatResult(C,C[0])||C[0]}}}return y}function n(){b.removeClass(g.loadingClass)}};a.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,callformatdelay:null,formatRequesturl:null,formatRequestype:null,formatRequestCode:null,ajaxfun:"ajax",matchCase:false,matchSubset:false,matchContains:false,cacheLength:10,max:100,mustMatch:false,extraParams:{},selectFirst:true,selecttrigger:true,formatItem:function(b){return b[0]},formatMatch:null,autoFill:false,width:0,txtValAuto:false,multiple:false,multipleSeparator:", ",highlight:function(c,b){return c.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180,websocket:true,websocketOption:"",websocketType:"jg",createUrlFun:function(b){}};a.Autocompleter.Cache=function(c){var f={};var d=0;function h(l,k){if(!c.matchCase){l=l.toLowerCase()}var j=l.indexOf(k);if(c.matchContains=="word"){j=l.toLowerCase().search(k.toLowerCase())}if(j==-1){return false}return j==0||c.matchContains}function g(j,i){if(d>c.cacheLength){b()}if(!f[j]){d++}f[j]=i}function e(){if(!c.data){return false}var k={},j=0;if(!c.url){c.cacheLength=1}k[""]=[];for(var m=0,l=c.data.length;m<l;m++){var p=c.data[m];p=(typeof p=="string")?[p]:p;var o=c.formatMatch(p,m+1,c.data.length);if(o===false){continue}var n=o.charAt(0).toLowerCase();if(!k[n]){k[n]=[]}var q={value:o,data:p,result:c.formatResult&&c.formatResult(p)||o};k[n].push(q);if(j++<c.max){k[""].push(q)}}a.each(k,function(r,s){c.cacheLength++;g(r,s)})}setTimeout(e,25);function b(){f={};d=0}return{flush:b,add:g,populate:e,load:function(n){if(!c.cacheLength||!d){return null}if(!c.url&&c.matchContains){var m=[];for(var j in f){if(j.length>0){var o=f[j];a.each(o,function(p,k){if(h(k.value,n)){m.push(k)}})}}return m}else{if(f[n]){return f[n]}else{if(c.matchSubset){for(var l=n.length-1;l>=c.minChars;l--){var o=f[n.substr(0,l)];if(o){var m=[];a.each(o,function(p,k){if(h(k.value,n)){m[m.length]=k}});return m}}}}}return null}}};a.Autocompleter.Select=function(g,l,n,s){var k={ACTIVE:"ac_over"};var m,h=-1,u,o="",v=true,e,q,c;var d=a(l).attr("autocomplete","off").addClass(g.inputClass);function p(){if(!v){return}e=a("<div/>").hide().addClass(g.resultsClass).css("position","absolute").appendTo(document.body);q=a("<ul/>").appendTo(e).mouseover(function(w){if(t(w).nodeName&&t(w).nodeName.toUpperCase()=="LI"){h=a("li",q).removeClass(k.ACTIVE).index(t(w));a(t(w)).addClass(k.ACTIVE)}}).click(function(w){a(t(w)).addClass(k.ACTIVE);n();l.focus();return false}).mousedown(function(){s.mouseDownOnSelect=true}).mouseup(function(){s.mouseDownOnSelect=false});if(g.width>0){e.css("width",g.width)}v=false}function t(x){var w=x.target;while(w&&w.tagName!="LI"){w=w.parentNode}if(!w){return[]}return w}function r(){}function j(w){m.slice(h,h+1).removeClass(k.ACTIVE);i(w);var y=m.slice(h,h+1).addClass(k.ACTIVE);if(g.scroll){var x=0;m.slice(0,h).each(function(){x+=this.offsetHeight});if((x+y[0].offsetHeight-q.scrollTop())>q[0].clientHeight){q.scrollTop(x+y[0].offsetHeight-q.innerHeight())}else{if(x<q.scrollTop()){q.scrollTop(x)}}}}function i(w){h+=w;if(h<0){h=m.size()-1}else{if(h>=m.size()){h=0}}}function b(w){return g.max&&g.max<w?g.max:w}function f(){q.empty();var x=b(u.length);for(var y=0;y<x;y++){if(!u[y]){continue}var z=g.formatItem(u[y].data,y+1,x,u[y].value,o);if(z===false){continue}var w=a("<li/>").html(g.highlight(z,o)).addClass(y%2==0?"ac_even":"ac_odd").appendTo(q)[0];a.data(w,"ac_data",u[y])}m=q.find("li");if(g.selectFirst){m.slice(0,1).addClass(k.ACTIVE);h=0}if(a.fn.bgiframe){q.bgiframe()}}return{display:function(x,w){p();u=x;o=w;if(g.callformatdelay===true){r()}else{f()}},next:function(){this.getSelectName();j(1)},prev:function(){this.getSelectName();j(-1)},pageUp:function(){if(h!=0&&h-8<0){j(-h)}else{j(-8)}},pageDown:function(){if(h!=m.size()-1&&h+8>m.size()){j(m.size()-1-h)}else{j(8)}},hide:function(){e&&e.hide();m&&m.removeClass(k.ACTIVE);h=-1},visible:function(){return e&&e.is(":visible")},current:function(){return this.visible()&&(m.filter("."+k.ACTIVE)[0]||g.selectFirst&&m[0])},show:function(){var y=a(l).offset();e.css({width:typeof g.width=="string"||g.width>0?g.width:a(l).width()+75,top:y.top+l.offsetHeight,left:y.left-24}).show();if(g.scroll){q.scrollTop(0);q.css({maxHeight:g.scrollHeight,overflow:"auto"});if(typeof document.body.style.maxHeight==="undefined"){var w=0;m.each(function(){w+=this.offsetHeight});var x=w>g.scrollHeight;q.css("height",x?g.scrollHeight:w);if(!x){m.width(q.width()-parseInt(m.css("padding-left"))-parseInt(m.css("padding-right")))}}}},selected:function(x){c=m.filter("."+k.ACTIVE);var w=m&&c.removeClass(k.ACTIVE);if(!g.txtValAuto){w=w}else{if(window.event.keyCode==40){if(typeof(w.next()[0])=="undefined"){return a.data(m[0],"ac_data")}else{w=w.next()}}else{if(window.event.keyCode==38){if(typeof(w.prev()[0])=="undefined"){return a.data(m[m.length-1],"ac_data")}else{w=w.prev()}}}}return w&&w.length&&a.data(w[0],"ac_data")},emptyList:function(){q&&q.empty()},unbind:function(){e&&e.remove()},getselectedli:function(){return c},getSelectName:function(){if(g.txtValAuto){var w=this.selected().data.name;if(w.substring(0,1)=="*"){w=w.substring(1,w.length)}else{if(w.substring(0,2)=="*."){w=w.substring(2,w.length)}else{w=w}}d.val(w)}}}};a.fn.selection=function(i,b){if(i!==undefined){return this.each(function(){if(this.createTextRange){var j=this.createTextRange();if(b===undefined||i==b){j.move("character",i);j.select()}else{j.collapse(true);j.moveStart("character",i);j.moveEnd("character",b);j.select()}}else{if(this.setSelectionRange){this.setSelectionRange(i,b)}else{if(this.selectionStart){this.selectionStart=i;this.selectionEnd=b}}}})}var g=this[0];if(g.createTextRange){var c=document.selection.createRange(),h=g.value,f="<->",d=c.text.length;c.text=f;var e=g.value.indexOf(f);g.value=h;this.selection(e,e+d);return{start:e,end:e+d}}else{if(g.selectionStart!==undefined){return{start:g.selectionStart,end:g.selectionEnd}}}}})(jQuery);